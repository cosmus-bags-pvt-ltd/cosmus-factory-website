{% extends 'product/base.html' %}
{% load static %}
{% block body %}

<form method="POST">
    {% csrf_token %}
    
    <div class="mt-3">
        <div class="mb-2 d-flex">
            <input type="hidden" id="hiddenDeliveryChallan" value="{{ product_list }}">
            <input type="hidden" id="hiddencreateDeliveryChallan" value="">
            <div class="d-flex">
                <label for="id_delivery_challan_no" class="me-1">Challan no :</label>
                {% if master_form.instance.id %}
                <input type="text" class="purchase-mark me-2" name="delivery_challan_no" maxlength="252" required id="id_delivery_challan_no" value="{{ master_form.instance.delivery_challan_no }}" readonly>
                {% elif not master_form.instance.id %}
                <input type="text" class="purchase-mark me-2" name="delivery_challan_no" value="{{ master_form.delivery_challan_no.initial }}" maxlength="252" required id="id_delivery_challan_no">
                {% endif %}
            </div>
            <div>
                <div class="d-flex" >
                    <div class="mb-1">
                        <label for="id_selected_godown" class="me-1">Godown :</label>
                        <select name="selected_godown" class="item-select " required id="id_selected_godown" class="item-selects">
                            {% if master_form.instance.id %}
                            <option value="{{ master_form.instance.selected_godown.id }}">{{ master_form.instance.selected_godown.godown_name_finished }}</option>
                            {% elif not master_form.instance.id %}
                            <option value="" selected disabled>selected_godown</option>
                            {% for godown in godowns %}
                              <option value="{{ godown.id }}">{{ godown.godown_name_finished }}</option>
                            {% endfor %}
                            {% endif %}
                        </select>
                    </div>
    
    
                    <div class="mb-1 ms-2">
                        <label for="id_party_name" class="me-1">Party name :</label>
                        <select name="party_name" class="item-select me-2" required id="id_party_name" class="item-selects">
                            {% if master_form.instance.id %}
                            
                            <option value="{{ master_form.instance.party_name.id }}">{{ master_form.instance.party_name.name }}</option>
                            {% elif not master_form.instance.id %}
                            <option value="" selected disabled>select party name</option>
                            {% for name in party_names %}
                              <option value="{{ name.id }}">{{ name.name }}</option>
                            {% endfor %}
                            {% endif %}
                        </select>
                       
                    </div>
                    <label for="id_shipping_address" class="me-1">Address :</label>
                <div>
                    {% if master_form.instance.id %}
                    <textarea  placeholder="Shipping Address.." name="shipping_address" class="border-1 rounded-1 ps-1" cols="35" rows="2" required id="id_shipping_address">{{ master_form.instance.shipping_address }}</textarea>
                    {% elif not master_form.instance.id %}
                    <textarea  placeholder="Shipping Address.." name="shipping_address" class="form-control" cols="35" rows="2" required id="id_shipping_address"></textarea>
                    {% endif %}
                </div>
                   
            </div>
                

            </div>
            <!-- <div>
                {% if master_form.instance.id %}
            <p name="party_address" class="border-1 rounded-1 ps-1 " id="id_party_address" readonly >{{ master_form.instance.party_name.address }}</p>
            {% elif not master_form.instance.id %}
            <p name="party_address" class="border-1 rounded-1 ps-1" id="id_party_address" readonly>test</p>
            {% endif %}
            </div> -->
            
           
        </div>
   
        <div>
            <table class="table table-striped table-hover table-bordered table-primary"  id="deliveryChallanTable">
                <thead class="name_absolute sticky-top">
                    <tr>
                        <th>No</th>
                        <th>Ref No</th>
                        <th>Model Name</th>
                        <th>Color</th>
                        <th>SKU</th>
                        <th>Qty</th>
                        <th>Delete</th>
                    </tr>
                </thead>
                <tbody class="mainTableList">

                    {{ formset.management_form }}
                    {% for form in formset %}
                    {{form.id}}
                    <tr>
                        <td><input type="number" class="rowNo purchase-mark bg-transparent border-0" name="rowNo_{{forloop.counter0}}" id="rowNo_{{forloop.counter0}}" value="{{forloop.counter}}" readonly></td>

                        <td><input type="text" name="{{form.prefix}}-product_RefNo" id="id_{{form.prefix}}-product_RefNo" class=" purchase-amount" value="{{ form.instance.product_name.Product.Product_Refrence_ID }}" readonly></td>

                        <td>
                            <div class="custom-dropdown-container">
                                <input type="text" name="{{form.prefix}}-products" id="id_{{form.prefix}}-products" class="productpurchaseInvoice search-input stock_product_name"  placeholder="Product Name" autocomplete="off" value="{{ form.instance.product_name.Product.Model_Name }}">

                                <div name="select_product_name_{{forloop.counter0}}" class="productpurchaseInvoice stock_input_name s-suggestion-container item-select_input" id="select_product_name_{{forloop.counter0}}" style="display: none; height:auto;" dir="auto" spellcheck="false" tabindex="0" aria-label="Product Name" >
                                </div>
                            </div> 
                        </td>

                        <td><input type="text" name="stock_color_{{forloop.counter0}}" id="id_stock_color_{{forloop.counter0}}" class="purchase-amount stock_color" value="{{ form.instance.product_name.PProduct_color.color_name }}" readonly style="outline: none;"></td>

                        <td><input type="number" class="purchase-amount stock_color" name="{{form.prefix}}-product_name" id="id_{{form.prefix}}-product_name" value="{{ form.instance.product_name.PProduct_SKU }}" style="outline: none;" readonly>
                            <input type="hidden" class="purchase-amount " name="productSku-{{forloop.counter0}}" id="id_productSku-{{forloop.counter0}}" value=""  readonly>
                        </td>

                        <td><input type="text" class="product_remark stock_qty" name="{{form.prefix}}-quantity" maxlength="200" id="id_{{form.prefix}}-quantity" value="{{ form.instance.quantity | default_if_none:'' }}">
                            <input type="hidden" class="purchase-vNo" name="quantity-{{forloop.counter0}}" maxlength="200" id="id_quantity-{{forloop.counter0}}" value="">
                        </td>

                        <td>
                            <span class="delete-btn border-0 bg-transparent" style="cursor: pointer;"><i class="fa-solid fa-trash text-danger px-3 py-2 fs-6"><input type="checkbox" class="stock_deleteId px-2" style="display: none;" name="{{form.prefix}}-DELETE" id="id_{{form.prefix}}-DELETE" value="" readonly></i></span>
                        </td>
                    </tr>
                    {% endfor %}
                    
                </tbody>
                <tr>
                    <td colspan="5">Total :</td>
                    <td><input type="text" value="" class="product_remark  border-0 stock_qty" name="total-quantity" maxlength="200" id="id_total-quantity" readonly></td>
                    <td></td>
                </tr>
            </table>
            <input  type="number" class="product_row" name="productRow" id="id_productRow" value="1">
            <button type="button" class="create-btn" id="addRowButton">Add +</button>
        </div>

        <div class="mb-2">
            {% if master_form.instance.id %}

            <div class="mb-2">
                <label for="id_vehicle_no" class="me-1">Vehicle no :</label>
                <input type="text" class="purchase-itemName me-3" name="vehicle_no" maxlength="50" required id="id_vehicle_no" value="{{ master_form.instance.vehicle_no}}">
                <label for="id_driver_name" class="me-1">Driver name :</label>
                <input type="text" class="purchase-itemName me-3" name="driver_name" maxlength="100" required id="id_driver_name" value="{{ master_form.instance.driver_name}}">
                <label for="id_dispatch_time" class="me-1">Dispatch time :</label>
                <input type="text" class="purchase-itemName me-3" name="dispatch_time" required id="id_dispatch_time" value="{{ master_form.instance.dispatch_time|time:'H:i' }}" readonly> 
                <label for="id_no_of_boxes" class="me-1">No of boxes :</label>
                <input type="number" class="me-1 purchase-mark" name="no_of_boxes" min="0" required id="id_no_of_boxes" value="{{ master_form.instance.no_of_boxes}}">
                <label for="id_no_of_pcs" class="me-1">No of pcs :</label>
                <input type="number" class="me-1 product_remark" name="no_of_pcs" min="0" required id="id_no_of_pcs" readonly value="{{ master_form.instance.no_of_pcs}}">
            </div>
            <div class="mb-2">
                
                <label for="id_remark" class="me-1">Remark :</label>
                <input type="text" name="remark" class="productpurchaseInvoice " required id="id_remark" value="{{ master_form.instance.remark}}">
            </div>

            {% elif not master_form.instance.id %}

            <div class="mb-2">
                <label for="id_vehicle_no" class="me-1">Vehicle no :</label>
                <input type="text" class="purchase-itemName me-3" name="vehicle_no" maxlength="50" required id="id_vehicle_no">
                <label for="id_driver_name" class="me-1">Driver name :</label>
                <input type="text" class="purchase-itemName me-3" name="driver_name" maxlength="100" required id="id_driver_name">
                <label for="id_dispatch_time" class="me-1">Dispatch time :</label>
                <input type="text" class="purchase-itemName me-3" name="dispatch_time" required id="id_dispatch_time_create" readonly> 
                <label for="id_no_of_boxes" class="me-1">No of boxes :</label>
                <input type="number" class="me-1 purchase-mark" name="no_of_boxes" min="0" required id="id_no_of_boxes">
                <label for="id_no_of_pcs" class="me-1">No of pcs :</label>
                <input type="number" class="me-1 product_remark" name="no_of_pcs" min="0" required id="id_no_of_pcs" readonly>
            </div>
            <div class="mb-2">
               
                <label for="id_remark" class="me-1">Remark :</label>
                <input type="text" name="remark" class="productpurchaseInvoice " required id="id_remark">
            </div>

            {% endif %}
        </div>

        </div>

    <button type="submit" id="submitButtonStockTransfer" class="create-btn mt-4" name="save" value="Save">Submit</button>
</form>



<script>
    function setRealTime() {
        const now = new Date();
        let hours = now.getHours();
        let minutes = now.getMinutes();

        // Add leading zero if minutes < 10
        if (minutes < 10) {
            minutes = '0' + minutes;
        }

        // Format time as HH:MM (24-hour format)
        const currentTime = hours + ':' + minutes;
        document.getElementById('id_dispatch_time_create').value = currentTime;
    }

    window.onload = setRealTime;

    setInterval(setRealTime, 1000);

    $(document).ready(function () {
        var searchedItemNameDict;
        var enterPressed = false;
        var itemName;
        var purchaseValue;
        var filterData;
        
        var formid = $('#id_deliverychallanproducts_set-0-id').val();
        if(formid === ''){
            $(document).on('change','#id_party_name',function(){
                var partyName = $(this).val();
                console.log('partyName',partyName)
                $.ajax({
                    url:"/deliverychallancreate/",
                    method: 'GET',
                    data: {
                        'partyName': partyName,
                        
                    },
                    success: function (response) {
                        console.log(response.address)
                        $('#id_party_address').text(response.address)
                    },
                    error: function (error) {   
                        console.log(error);
                    }


                })
            })
        }
    
        $(document).on('click input keyup focus keydown', 'input[name$="-products"]', function () {
            itemName = $(this).closest('tr').find('input[name$="-quantity"]').attr('name');
            purchaseValue = itemName.split('-')[1];
                    
        });

        $(document).on('input', 'input[name$="-products"]', function(e) {
            var StockValue = $(this).attr('name').match(/\d+/)[0]; // Extract the numeric value from the input name
            var nameValue = $(this).val().trim();
            var selectNameValue = `select_product_name_${StockValue}`;
            var suggestionsContainer = $(`#${selectNameValue}`);
            const selected_godown = $('#id_selected_godown').val();
            console.log('selected_godown',selected_godown)
            if (nameValue === 'None' || nameValue === '') {
            suggestionsContainer.css('display', 'none').empty();
                $(this).attr('data-key', '');
                return;
            }
            if(!enterPressed){
                suggestionsContainer.css('display', 'block');
            }
            enterPressed = false;
            
            function escapeRegExp(string) {
                return string.replace(/[.*+?^${}()|[\]\\,]/g, '\\$&');
            }
            $.ajax({
                url:"/deliverychallanproductajax/",
                method: 'GET',
                data: {
                    'nameValue': nameValue,
                    'selected_godown':selected_godown
                },
                success: function (response) {
                    // console.log(response.products);
                    searchedProductNameDic = response.products; 
                    // console.log('searchedProductNameDic',searchedProductNameDic)
                    const searchQuery = nameValue.toLowerCase();
                    const searchTerms = searchQuery.split(/\s+/);
                    const convertStringData = searchTerms.toString();
                
                    const escapedTerms = searchTerms.map(escapeRegExp);

                    const regex = new RegExp(`(${escapedTerms.join('|')})`, 'gi');

                    const normalizeSpaces = (str) => str.replace(/\s+/g, ' ').trim();

                    const filteredOptions = Object.entries(searchedProductNameDic).filter(
                    ([key, value]) => {
                        const normalizedKey = normalizeSpaces(key.toString().toLowerCase());
                        const normalizedProductName = normalizeSpaces(value[1].toString().toLowerCase());
                        const normalizedColor = normalizeSpaces(value[0].toString().toLowerCase());
                    
                        const normalizedQuery = normalizeSpaces(convertStringData.toLowerCase());

                        return normalizedKey.includes(normalizedQuery) ||
                            normalizedProductName.includes(normalizedQuery) ||
                            normalizedColor.includes(normalizedQuery);
                    });

                    suggestionsContainer.empty();
                    // Generate suggestions for matching options
                    filteredOptions.forEach(([key, value], index) => {
                        // Extract relevant fields
                        const productName = value[1]; // Product name
                        const productSKU = key; // SKU
                        const productColor = value[0];
                        const productQty = value[4];

                        // Highlight matches in name, SKU, and color
                        const highlightedText = productName.replace(regex, '<span class="highlight">$1</span>');
                        const highlightedSKU = productSKU.replace(regex, '<span class="highlight">$1</span>');
                        const highlightedColor = productColor.replace(regex, '<span class="highlight">$1</span>');
                        // const highlightedQty = productQty.replace(regex, '<span class="highlight">$1</span>');

                        // Add the suggestion to the container
                        suggestionsContainer.append(`
                            <div id="itemName-div_${index}" class="itemName-div itemName-div-suggestion" data-key="${key}">
                                ${highlightedText}<span style="padding-left:20px">${highlightedColor}</span> <span style="float:right">${productQty}</span>
                            </div>
                        `);
                        
                    });
                    if(filteredOptions == ''){
                        suggestionsContainer.show();
                        suggestionsContainer.empty();
                        suggestionsContainer.append(`<div" class="itemName-div itemName-div-suggestion ">No item found</div>`);
                    }
                },
                error: function (response) {   
                    console.log(response);
                    alert("Please select Godown!!")
                }


            })
            
                
            suggestionsContainer.on('click', '.itemName-div', function(e) {
                var item_value = $(this).data('key');
                var itemNamevaluesCheck = $(this).text().trim();
                
        
                
                $(this).addClass('selected').siblings().removeClass('selected');

                if (item_value !== undefined) {
                    var selectedValue = searchedProductNameDic[item_value];
                    console.log('selectedValue',selectedValue)
                    var namevalueCheck = selectedValue[1];
                    const productQty = selectedValue[4];
                    const productColor = selectedValue[0];
                    const productRef = selectedValue[2]
                    var newNameValue = namevalueCheck + '                             '+ productQty;
                    console.log('productQty',productQty)
                    $(`input[name="deliverychallanproducts_set-${purchaseValue}-products"]`).val(newNameValue);
                    $(`input[name="deliverychallanproducts_set-${purchaseValue}-quantity"]`).focus();
                    $(`input[name="deliverychallanproducts_set-${purchaseValue}-product_name"]`).val(item_value)
                    $(`input[name="stock_color_${purchaseValue}"]`).val(productColor);
                    $(`input[name="deliverychallanproducts_set-${purchaseValue}-product_RefNo"]`).val(productRef);
                    $(`input[name^=quantity-${purchaseValue}]`).val(productQty);
                    $(`input[name^=productSku-${purchaseValue}]`).val(item_value);

                    var hiddenData = $('#hiddencreateDeliveryChallan').val();
                    var currentData = hiddenData && hiddenData.trim().toLowerCase() !== "none" ? JSON.parse(hiddenData) : {};

                    // ✅ Store SKU with Quantity (Overwrites if SKU already exists)
                    currentData[item_value] = productQty;

                    // Save updated data to the hidden input field
                    $('#hiddencreateDeliveryChallan').val(JSON.stringify(currentData));
            
                }
            
                suggestionsContainer.css('display', 'none');
                
            })

        })
        function safeParseJSON(jsonString) {
            try {
                if (!jsonString || jsonString.trim().toLowerCase() === "none") return {};
                return JSON.parse(jsonString);
            } catch (error) {
                console.error("Invalid JSON format:", jsonString, error);
                return {};
            }
        }

   
        $(document).on('input', 'input[name$="-quantity"]', function (e) {  
            let rowIndex = $(this).attr("id").match(/\d+/)[0]; 
            let productValue = parseInt($(`#id_deliverychallanproducts_set-${rowIndex}-quantity`).val()) || 0;
            let inputSku = $(`#id_deliverychallanproducts_set-${rowIndex}-product_name`).val();
            let productData = $('#hiddenDeliveryChallan').val();
            let hiddenValueData = $('#hiddencreateDeliveryChallan').val();

            if (!inputSku) {
                // console.log("❌ No SKU entered");
                return;
            }

            // console.log("Raw productData:", productData);
            // console.log("Raw hiddenValueData:", hiddenValueData);

            // Handle "None" values or empty strings
            if (!productData || productData.trim() === "None") productData = "{}";
            if (!hiddenValueData || hiddenValueData.trim() === "None") hiddenValueData = "{}";

            function cleanJsonString(jsonString) {
                try {
                    return jsonString
                        .replace(/'/g, '"')  // Convert single quotes to double quotes
                        .replace(/(\w+):/g, '"$1":')  // Ensure property names are quoted
                        .replace(/None/g, 'null');  // Replace 'None' with 'null'
                } catch (err) {
                    console.error("❌ Error cleaning JSON string:", err);
                    return "{}"; // Return empty object in case of failure
                }
            }

            let parsedProductData = {};
            let parsedHiddenValueData = {};

            try {
                parsedProductData = JSON.parse(cleanJsonString(productData));
            } catch (error) {
                console.error("❌ Error parsing productData:", error);
                parsedProductData = {}; // Set empty object to avoid further errors
            }

            try {
                parsedHiddenValueData = JSON.parse(cleanJsonString(hiddenValueData));
            } catch (error) {
                console.error("❌ Error parsing hiddenValueData:", error);
                parsedHiddenValueData = {}; // Set empty object to avoid further errors
            }

            // console.log("Parsed productData:", parsedProductData);
            // console.log("Parsed hiddenValueData:", parsedHiddenValueData);

            // Merge both objects
            let mergedData = { ...parsedHiddenValueData, ...parsedProductData };

            // console.log("Merged Data:", mergedData);

            if ($.isEmptyObject(mergedData)) {
                console.warn("⚠️ No valid product data found, assuming empty object.");
                return;
            }

            // Check if SKU exists in mergedData
            if (!(inputSku in mergedData)) {
                console.log(`❌ SKU ${inputSku} not found in mergedData.`);
                return;
            }

            let availableQty = parseInt(mergedData[inputSku]) || 0; // Retrieve available quantity

            // console.log(`🔹 SKU: ${inputSku} | Entered Qty: ${productValue} | Available Qty: ${availableQty}`);

            // Restrict input if entered quantity exceeds available quantity
            if (productValue > availableQty) {
                // console.log(`❌ Entered quantity ${productValue} exceeds available stock (${availableQty}).`);
                $(`#id_deliverychallanproducts_set-${rowIndex}-quantity`).val(availableQty);
            }

            // Calculate total quantity from the table
            let totalQty = 0;
            $('#deliveryChallanTable .mainTableList tr').each(function () {
                if ($(this).css('display') !== 'none') {
                    let qty = parseInt($(this).find('input[name$="-quantity"]').val()) || 0;
                    totalQty += qty;
                }
            });

            $('#id_total-quantity, #id_no_of_pcs').val(totalQty);
        });

        var index = 0; // Declare index outside of the event listener
        var indexbool = true;

        $(document).on('keydown', 'input[name$="-products"]', function(event) {
            const $inputField = $(this);
            const $dropdownOptions = $inputField.next('.stock_input_name');
            const $options = $dropdownOptions.find('.itemName-div');
            const optionsCount = $options.length - 1;
            const searchText = $inputField.val().trim();
            const hiddenValue = $inputField.closest('.custom-dropdown-container').find(`#select_product_name_${purchaseValue}`);
            if (searchText === '') {
                index = 0;
                return;
            }
            const newHeight = $inputField.offset();
            const windowHeight = $(window).height();
            const availableSpace = windowHeight - newHeight.top - $inputField.outerHeight();
    

            if (event.key === 'ArrowDown') {
                event.preventDefault();

                if (index <= optionsCount) {
                
                    const $selectedItem = $options.eq(index);
                    const $nextItem = $selectedItem.next();
                    const nameDataKey = $selectedItem.text();
                    const nameKey = $selectedItem.data('key');

                    $inputField.attr('data-key', nameKey);
                
                    $selectedItem.addClass('bg-highlight').siblings().removeClass('bg-highlight');
                    const itemOffsetTop = $nextItem.position().top;
                    const itemHeight = $nextItem.outerHeight();
                    const selectScrollTop = $dropdownOptions.scrollTop();
                    const selectHeight = $dropdownOptions.height();

                    if (itemOffsetTop + itemHeight > selectHeight) {
                        $dropdownOptions.scrollTop(selectScrollTop + itemHeight);
                    } else if (itemOffsetTop < 0) {
                        $dropdownOptions.scrollTop(selectScrollTop - itemHeight);
                    }
                    $selectedItem.addClass('selected');
                    if (index !== optionsCount) {
                        index += 1;
                        indexbool = true;
                    }
                } else {
                    index = 0;
                }
            }

            if (event.key === 'ArrowUp') {
                event.preventDefault();

                if (index != 0 && indexbool == true) {
                    index -= 1;
                }

                if (index <= optionsCount) {
                
                    const $selectedItem = $options.eq(index);
                    const $prevItem = $selectedItem.prev();
                    const nameDataKey = $selectedItem.text();
                    const nameKey = $selectedItem.data('key');

                    $inputField.attr('data-key', nameKey);
                    
                    $selectedItem.addClass('bg-highlight').siblings().removeClass('bg-highlight');
                    
                    const itemOffsetTop = $prevItem.position().top;
                    const itemHeight = $prevItem.outerHeight();
                    const selectScrollTop = $dropdownOptions.scrollTop();
                    const selectHeight = $dropdownOptions.height();

                    if (itemOffsetTop < 0) {
                        $dropdownOptions.scrollTop(selectScrollTop - itemHeight);
                    } else if (itemOffsetTop + itemHeight > selectHeight) {
                        $dropdownOptions.scrollTop(selectScrollTop + itemHeight);
                    }

                    $selectedItem.addClass('selected');
                } else {
                    index = 0;
                }
            }

            if (event.key === 'Enter') {
                event.preventDefault();
                const itemEnterValue = $(this);
                const item_value = itemEnterValue.attr('data-key');

                nameDataKey = '';
                nameKey = '';
                index = 0;
                indexbool = false;
                if (item_value !== undefined) {
                    var selectedValue = searchedProductNameDic[item_value];
                    
                    var namevalueCheck = selectedValue[1];
                    const productQty = selectedValue[4];
                    const productColor = selectedValue[0];
                    const productRef = selectedValue[2];
                
                    var newNameValue = namevalueCheck + '                             '+ productQty;
        
                    $(`input[name="deliverychallanproducts_set-${purchaseValue}-products"]`).val(newNameValue);
                    $(`input[name="deliverychallanproducts_set-${purchaseValue}-quantity"]`).focus();
                    $(`input[name="deliverychallanproducts_set-${purchaseValue}-product_name"]`).val(item_value)
                    $(`input[name="stock_color_${purchaseValue}"]`).val(productColor);
                    $(`input[name="deliverychallanproducts_set-${purchaseValue}-product_RefNo"]`).val(productRef);
                    $(`input[name^=quantity-${purchaseValue}]`).val(productQty)
                    
            //         let totalExistingQuantity = 0;
                
            //     $('input[name^="deliverychallanproducts_set-"][name$="-product_name"]').each(function () {
            //     var rowProductValue = parseInt($(this).val());
            //     var rowIndex = $(this).attr('name').match(/\d+/)[0]; // Extract index
              
            //     if (rowProductValue === item_value) {
            //         var rowQuantity = parseInt($(`input[name="deliverychallanproducts_set-${rowIndex}-quantity"]`).val()) || 0;
            //         totalExistingQuantity += rowQuantity;
    
            //         $(`input[name^=quantity-${purchaseValue}]`).val(totalExistingQuantity)
            //     }
      
            // })
                }
                enterPressed = true;
                hiddenValue.css("display" ,"none");
                $inputField.blur();
            }
            if (event.key === 'Tab' && enterPressed) {
            enterPressed = false; // Reset Enter key handling
            return true; // Allow default Tab behavior
            }
        })
        
        
    })

    document.addEventListener('DOMContentLoaded', function () {
        document.getElementById('id_delivery_challan_no').focus()
        const addRowButton = document.getElementById('addRowButton');
        const mainTable = document.querySelector('.mainTableList');

        if (addRowButton && mainTable) {
            addRowButton.addEventListener('click', function () {
                let addInputRow = parseInt(document.getElementById('id_productRow').value, 10);

                if (isNaN(addInputRow) || addInputRow <= 0) {
                    addInputRow = 1;
                    return;
                }
                let lastVisibleRow = null;
                mainTable.querySelectorAll('tr').forEach(row => {
                    if (window.getComputedStyle(row).display !== 'none') {
                        lastVisibleRow = row;
                    }
                });
                if (lastVisibleRow) {
                    const newForm = document.getElementById('id_deliverychallanproducts_set-TOTAL_FORMS');
                    
                    for(let i = 0; i<addInputRow; i++){
                        const newFormCount = parseInt(newForm.value);
                    const newTable = lastVisibleRow.cloneNode(true);
                    console.log('newFormCount',newFormCount)
                    newTable.querySelectorAll("input select").forEach(function (e) {
                        e.value = "";
                    });

                    const newId = newTable.querySelector('input[name^="rowNo_"]');
                    newId.id = `id_rowNo_${newFormCount}`;
                    newId.name = `rowNo_${newFormCount}`;
                    newId.value = newFormCount + 1;

                    const productReferenceElement = newTable.querySelector('input[name^="deliverychallanproducts_set-"][name$="-product_RefNo"]');
                    productReferenceElement.id = `id_deliverychallanproducts_set-${newFormCount}-product_RefNo`;
                    productReferenceElement.name = `deliverychallanproducts_set-${newFormCount}-product_RefNo`;
                    productReferenceElement.value = "";
                    productReferenceElement.style.outline ="none";

                    const productNameElement = newTable.querySelector('input[name^="deliverychallanproducts_set-"][name$="-products"]');
                    productNameElement.id = `id_deliverychallanproducts_set-${newFormCount}-products`;
                    productNameElement.name = `deliverychallanproducts_set-${newFormCount}-products`;
                    productNameElement.value = "";

                    const itemNameElement = newTable.querySelector('input[name^="deliverychallanproducts_set-"][name$="-product_name"]');
                    itemNameElement.id = `id_deliverychallanproducts_set-${newFormCount}-product_name`;
                    itemNameElement.name = `deliverychallanproducts_set-${newFormCount}-product_name`;
                    itemNameElement.value = "";
                    itemNameElement.style.readonly =false;

                    const selectElement = newTable.querySelector('.stock_input_name[name^="select_product_name_"]');
                    selectElement.id = `select_product_name_${newFormCount}`;
                    selectElement.name = `select_product_name_${newFormCount}`;
                    selectElement.innerHTML = '';

                    const selectSkuElement = newTable.querySelector('input[name^="productSku-"]');
                    selectSkuElement.id = `id_productSku-${newFormCount}`;
                    selectSkuElement.name = `productSku-${newFormCount}`;
                    selectSkuElement.value = '';

                    const itemColorElement = newTable.querySelector('input[name^="stock_color_"]');
                    itemColorElement.id = `id_stock_color_${newFormCount}`;
                    itemColorElement.name = `stock_color_${newFormCount}`;
                    itemColorElement.value = "";

                    const itemQuantityElement = newTable.querySelector('input[name^="deliverychallanproducts_set-"][name$="-quantity"]');
                    itemQuantityElement.id = `id_deliverychallanproducts_set-${newFormCount}-quantity`;
                    itemQuantityElement.name = `deliverychallanproducts_set-${newFormCount}-quantity`;
                    itemQuantityElement.value = "";

                    const QuantityElement = newTable.querySelector('input[name^="quantity-"]');
                    QuantityElement.id = `id_quantity-${newFormCount}`;
                    QuantityElement.name = `quantity-${newFormCount}`;
                    QuantityElement.value = "";


                    const deleteElement = newTable.querySelector('.stock_deleteId[name^="deliverychallanproducts_set-"][name$="-DELETE"]');
                    deleteElement.id = `id_deliverychallanproducts_set-${newFormCount}-DELETE`;
                    deleteElement.name = `deliverychallanproducts_set-${newFormCount}-DELETE`;
                    deleteElement.value = "";
                    deleteElement.checked = false;

                    newForm.value = newFormCount + 1;

                    mainTable.appendChild(newTable);
                    }
                    document.getElementById('id_productRow').value = '1';
                        deleteRow();
                        
                        inputCheck();
                    
                } else {
                    console.error("No visible rows found to clone.");
                }
            });
        }
        function getVisibleRows() {
            // Select all rows that are not hidden (excluding those with display: none)
            const visibleRows = document.querySelectorAll('.mainTableList tr:not([style*="display: none"])');
            return visibleRows;
        }

        function deleteRow() {
            // Add click event listener to all delete buttons
            document.querySelectorAll('.delete-btn').forEach(function (button) {
                button.addEventListener('click', function () {
                    // Find the row containing the clicked delete button
                    const rows = getVisibleRows();
                    if (rows.length > 1) {
                            // Find the row containing the clicked delete button
                    const row = this.closest('tr');

                    if (row) {
                        // Find the checkbox for deletion in the row
                        const checkRow = row.querySelector('.stock_deleteId[name^="deliverychallanproducts_set-"][name$="-DELETE"]');

                        if (checkRow) {
                            checkRow.checked = true; // Mark as checked
                            checkRow.value = 'true'; // Set the value to 'true'

                            row.style.display = 'none';
                            calculateTotal()
                        } else {
                            console.error("Checkbox for deletion not found in this row");
                        }
                    }
                } else {
                    // If only one row remains, alert the user
                    alert('Cannot delete this row; at least one row must remain.');
                }   
                });
            });
        };


        function calculateTotal() {
            var tables = Array.from(document.querySelectorAll('#deliveryChallanTable .mainTableList tr'))
            .filter(row => row.style.display !== 'none');

            var value = 0;
    
            tables.forEach(function(row) {
                var inputField = row.querySelector('[name$="-quantity"]');
                if (inputField) {
                    var qty = parseInt(inputField.value) || 0; // Default to 0 if NaN
                    value += qty;
                }
            });

            document.getElementById('id_total-quantity').value = value;
            document.getElementById('id_no_of_pcs').value = value;
        }

        document.querySelector('[name$="-quantity"]').addEventListener('input', function() {

            calculateTotal();
        });

    calculateTotal()
    deleteRow();


    inputCheck()
   
});


function inputCheck() {
    const itemNameInputs = document.querySelectorAll('[name$="-products"]');
    const godown = document.getElementById('id_selected_godown')
    const productInvoiceId = document.getElementById('id_deliverychallanproducts_set-0-id').value;
    const challanNo = document.getElementById('id_delivery_challan_no');
    const partyName = document.getElementById('id_party_name');
    const shipping_address = document.getElementById('id_shipping_address');
    const vehicelNo = document.getElementById('id_vehicle_no');
    const driverName = document.getElementById('id_driver_name');
    const dispatchTime = document.getElementById('id_dispatch_time');
    const noBox = document.getElementById('id_no_of_boxes');
    const remark = document.getElementById('id_remark');
    var AddElement = document.getElementById('addRowButton');
    var tableRows = document.querySelectorAll('#deliveryChallanTable .mainTableList tr');

    challanNo.addEventListener('keydown',function(event){
        if(event.key === 'Tab'){
            event.preventDefault();
            if(challanNo.value === ''){
                challanNo.focus();
                return;
            }else{
                godown.focus()
            }
        }
    })
    godown.addEventListener('keydown',function(event){
        if(event.key === 'Tab'){
            event.preventDefault();
            if(godown.value === ''){
                godown.focus();
                return;
            }else{
                partyName.focus()
            }
        }
    })
    partyName.addEventListener('keydown',function(event){
        if(event.key === 'Tab'){
            event.preventDefault();
            if(partyName.value === ''){
                partyName.focus();
                return;
            }else{
                shipping_address.focus()
            }
        }
    })
    shipping_address.addEventListener('keydown',function(event){
        if(event.key === 'Tab'){
            event.preventDefault();
            if(shipping_address.value === ''){
                shipping_address.focus();
                return;
            }else{
                var tableRow = document.querySelectorAll('#deliveryChallanTable .mainTableList tr');
                for (let row of tableRow) {
                    var itemInput = row.querySelector('[name$="products"]');
                    var qtyInput = row.querySelector('[name$="-quantity"]');

                    if (itemInput && itemInput.value === '') {
                        itemInput.focus();
                        return; 
                    } 
                    // Check if quantity is empty, then focus on it
                    else if (qtyInput && qtyInput.value === '') {
                        qtyInput.focus();
                        return; 
                    }
                }
            }
        }
    })
    itemNameInputs.forEach((input, index) => {
        if (input) {
            input.addEventListener("keydown", function (event) {
                const closestRow = input.closest('tr');
                const qtyInput = closestRow.querySelector('[name$="-quantity"]');

                if (productInvoiceId === 'None') {
                  
                    if (event.key === "Tab" || event.key === "Enter") {
                        event.preventDefault(); 

                        if (input.value.trim() !== "") {
                            if (qtyInput) {
                                qtyInput.focus(); 
                            }
                        } else {
                            input.focus(); 
                        }
                    }
                }
            });
        }
    });

    tableRows.forEach(function(row ,index){
        var qty = row.querySelector('[name$="-quantity"]');
        if(qty){
            qty.addEventListener('keydown', function (event) {
                if (event.key === "Tab") {
                    event.preventDefault();

                    if (qty.value === '') {
                       
                        qty.focus();
                    } else {
                        var nextRow = tableRows[index + 1];;
                
                        if (nextRow) {
                            var nextItemInput = nextRow.querySelector('[name$="-products"]');
                            console.log('nextRow',nextItemInput)
                            if (nextItemInput && nextItemInput.value === '') {
                                nextItemInput.focus();
                            } else {
                                var nextQtyInput = nextRow.querySelector('[name$="-quantity"]');
                                if (nextQtyInput) {
                                    nextQtyInput.focus();
                                }
                            }
                        } else {
                        
                            
                            if (AddElement) {
                              AddElement.focus();
                                
                               
                            }
                        }
                    }
                }
            });
        }
    })
    AddElement.addEventListener('keydown', function (event) {
        if (event.key === "Tab") {
            event.preventDefault();
            vehicelNo.focus()
        }

    })
    vehicelNo.addEventListener('keydown',function(event){
        if(event.key === 'Tab'){
            event.preventDefault();
            if(vehicelNo.value === ''){
                vehicelNo.focus();
                return;
            }else{
                driverName.focus()
            }
        }
    })
    driverName.addEventListener('keydown',function(event){
        if(event.key === 'Tab'){
            event.preventDefault();
            if(driverName.value === ''){
                driverName.focus();
                return;
            }else{
                dispatchTime.focus()
            }
        }
    })
    dispatchTime.addEventListener('keydown',function(event){
        if(event.key === 'Tab'){
            event.preventDefault();
            if(dispatchTime.value === ''){
                dispatchTime.focus();
                return;
            }else{
                noBox.focus()
            }
        }
    })
    noBox.addEventListener('keydown',function(event){
        if(event.key === 'Tab'){
            event.preventDefault();
            if(noBox.value === ''){
                noBox.focus();
                return;
            }else{
                remark.focus()
            }
        }
    })
    remark.addEventListener('keydown',function(event){
        if(event.key === 'Tab'){
            event.preventDefault();
            if(remark.value === ''){
                remark.focus();
                return;
            }else{
                document.getElementById('submitButtonStockTransfer').focus()
            }
        }
    })
}

inputCheck()
</script>

{% endblock body %}
