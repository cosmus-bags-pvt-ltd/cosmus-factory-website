{% extends 'product/base.html' %} 
{% load static %} 

{% block body %}

<form method="POST">
    {% csrf_token %}
    <!-- {% for form in picklist_formset %}
      {{ form.as_p }}
    {% endfor %} -->
    <div class="mb-3 mt-2">
        <div class="d-flex">
            <input type="hidden" id="picklistupdateData" value="{{dict_to_send}}">
            <input type="hidden" id="picklistHiddenData" value="">
         <div class="">
            <label for="id_pickList_no" class="fw-bold">Add Picklist+ :</label>
    
            <input type="text" name="pickList_no" class="purchase-mark  ms-1 me-1" id="id_pickList_no">
            

            <label for="id_outward_no" class="fw-bold ms-1 me-1">Outward No :</label>
            {% if master_form.instance.id %}
            <input type="text" name="outward_no" value = "{{ master_form.instance.outward_no }}" class="purchase-vNo ms-1 me-1" id="id_outward_no" readonly>
            {% elif not master_form.instance.id %} 
            <input type="text" name="outward_no" class="purchase-vNo ms-1 me-1" value="{{ master_form.outward_no.initial }}" id="id_outward_no" required>
            {% endif %}

            <label for="inwordSerialNo" class="fw-bold me-1">Scan :</label>
            <input type="text" name="scanned_serial_number" class="item-selects ms-1 me-1" id="inwordSerialNo">
            <label for="id_manualSerialNo" class="fw-bold ms-1">M-Scan :</label>
            <input type="text" name="manual_serial_number" class="item-selects ms-1 me-1" id="id_manualSerialNo">
       </div>
        
    </div>
    <div>
        <div class="row mt-1">
            <div class="col-lg-2">
                <table class="table table-striped table-hover table-bordered table-warning" id="picklistTable">
                    <thead class="name_absolute">
                        <tr>
                            <th>Pick No</th>
                            <th>Qty</th>
                            <th>Balance</th>
                            <th>check</th>
                        </tr>
                    </thead>
                    <tbody class="mainTableList">
                        {{ picklist_formset.management_form }}
                        {% for form in picklist_formset %}
                        {{ form.id }}
                        <tr>
                            <input type="hidden" name="{{form.prefix}}-pickId" id="id_{{form.prefix}}-pickId" value="{{ form.instance.id }}">
                            <td><input type="hidden" class="rowNo picklistId" name="{{form.prefix}}-picklist" id="id_{{form.prefix}}-picklist" value="{% if form.instance.id %}{{ form.instance.picklist.id }}{% endif %}" readonly>
                                <input type="number" class="rowNo pickId" name="{{form.prefix}}-picklistNo" id="id_{{form.prefix}}-picklistNo" value="{% if form.instance.id %}{{ form.instance.picklist.picklist_no }}{% endif %}" readonly></td>
                            <td>
                                <input type="number" class="rowNo pickQty outwardPick-btn" name="{{form.prefix}}-picklistQty" id="id_{{form.prefix}}-picklistQty" value="{% if form.instance.id %}{{ form.instance.picklist.total_qty }}{% endif %}" readonly data-bs-toggle="modal" data-bs-target="#staticBackdrop" style="cursor: pointer;">
                            </td>
                            <td><input type="number" class="rowNo pickBalance" name="{{form.prefix}}-balance_qty" id="id_{{form.prefix}}-balance_qty" value="{% if form.instance.id %}{{ form.instance.balance_qty }}{% endif %}" readonly></td>
                            <td><input type="radio" class="picklistRadio" name="picklist_group"></td>
                        </tr>

                        {% endfor %}

                    </tbody>
                </table>
            </div>
            <div class="col-lg-5">
                <div class="mt-2"> 
                    <span id="responseMessage" class="ms-1 fw-bold"></span></div>
                </div>
            </div>
        </div>
        
    </div>   
    
    <table class="table table-striped table-hover table-bordered" id="outwardSales">
        <thead class="name_absolute">
            <tr>
                <th>No</th>
                <th>Ref No</th>
                <th>Model Name</th>
                <th>Color</th>
                <th>Sku</th>
                <th>Image</th>
                <th>Serial No</th>
                <th>Bin</th>
                <th>Quantity</th>
                <th>Delete</th>
            </tr>
        </thead>
        <tbody class="mainTableList">
            {{ formset.management_form }}
            {% for form in formset %}
            {{form.id}}
                {% if form.instance.id %}
                <tr>
                    <input type="hidden" name="picklistNo_{{forloop.counter0}}" id="id_picklistNo_{{forloop.counter0}}" value="">

                    <td>
                        <input type="number" class="rowNo purchase-mark bg-transparent border-0" name="rowNo_{{forloop.counter0}}" id="rowNo_{{forloop.counter0}}" value="{{forloop.counter}}">
                    </td>

                    <td>
                        <input type="text" name="{{form.prefix}}-product_RefNo" id="id_{{form.prefix}}-product_RefNo" class=" purchase-amount" value="{{form.instance.product.Product.Product_Refrence_ID}}" readonly>
                    </td>

                    <td>  
                        <input type="text" name="{{form.prefix}}-product_name_value" id="id_{{form.prefix}}-product_name_Value" class="productpurchaseInvoice search-input"  placeholder="Product Name" value="{{form.instance.product.Product.Model_Name}}" readonly> 
                    </td>

                    <td>
                        <input type="text" name="product_color_{{forloop.counter0}}" id="product_color_{{forloop.counter0}}" value="{{form.instance.product.PProduct_color.color_name}}" class="purchase-input"  readonly>
                    </td>
    
                    <td>
                        <input type="text" name="{{form.prefix}}-product" id="id_{{form.prefix}}-product" value="{{form.instance.product.PProduct_SKU}}" class="purchase-amount" readonly>
                    </td>
                
                    <td>
                        <img src="{{ form.instance.product.PProduct_image.url }}" id="product_img_{{forloop.counter0}}"  style="width: 30px; height: 30px; cursor: pointer;" alt="product"  onclick="showLargeImage(this.src)">
                    </td>
                    <td>
                        <input type="text" name="{{form.prefix}}-unique_serial_no" maxlength="25" id="id_{{form.prefix}}-unique_serial_no" class="purchase-amount" value="{{ form.instance.unique_serial_no }}" readonly>
                    </td>

                    <td>
                        <input type="text" name="{{form.prefix}}-bin_no" id="id_{{form.prefix}}-bin_no" class="purchase-amount" value="{{form.instance.bin_number.bin_name}}" readonly>
                        <input type="hidden" name="{{form.prefix}}-bin_number" id="id_{{form.prefix}}-bin_number" class="purchase-amount" value="{{ form.instance.bin_number.id }}" readonly>
                    </td>

                    <td>
                        <input type="number" name="{{form.prefix}}-quantity" id="id_{{form.prefix}}-quantity" class="purchase-input" value="{{ form.instance.quantity }}" readonly>
                    </td>

                    <!-- <td>
                        <span class="delete-btn border-0 bg-transparent" style="cursor: pointer;"><i class="fa-solid fa-trash text-danger px-3 py-2 fs-6"><input type="checkbox" class="godown_deleteId px-2" style="display: none;"  name="{{form.prefix}}-DELETE" id="id_{{form.prefix}}-DELETE" value=""></i></span>
                    </td>   -->
                </tr>


                {% elif not form.instance.id %}
                <tr>
                    <input type="hidden" name="picklistNo_{{forloop.counter0}}" id="id_picklistNo_{{forloop.counter0}}" value="">

                    <td>
                        <input type="number" class="rowNo purchase-mark bg-transparent border-0" name="rowNo_{{forloop.counter0}}" id="rowNo_{{forloop.counter0}}" value="{{forloop.counter}}">
                    </td>

                    <td>
                        <input type="text" name="{{form.prefix}}-product_RefNo" id="id_{{form.prefix}}-product_RefNo" class=" purchase-amount" value="" readonly>
                    </td>

                    <td>  
                        <input type="text" name="{{form.prefix}}-product_name_value" id="id_{{form.prefix}}-product_name_Value" class="productpurchaseInvoice search-input"  placeholder="Product Name" value="" readonly> 
                    </td>

                    <td>
                        <input type="text" name="product_color_{{forloop.counter0}}" id="product_color_{{forloop.counter0}}" value="" class="purchase-input" style="margin-left: 10px;" readonly>
                    </td>
    
                    <td>
                        <input type="text" name="{{form.prefix}}-product" id="id_{{form.prefix}}-product" value="" class="purchase-amount" readonly>
                    </td>
                
                    <td>
                        <img src="" id="product_img_{{forloop.counter0}}"  style="width: 30px; height: 30px; cursor: pointer;" alt="product"  onclick="showLargeImage(this.src)">
                    </td>
                    <td>
                        <input type="text" name="{{form.prefix}}-unique_serial_no" maxlength="25" id="id_{{form.prefix}}-unique_serial_no" class="purchase-amount" readonly>
                    </td>

                    <td>
                        <input type="text" name="{{form.prefix}}-bin_no" id="id_{{form.prefix}}-bin_no" class="purchase-amount" readonly>
                        <input type="hidden" name="{{form.prefix}}-bin_number" id="id_{{form.prefix}}-bin_number" class="purchase-amount" readonly>
                    </td>

                    <td>
                        <input type="number" name="{{form.prefix}}-quantity" value="" id="id_{{form.prefix}}-quantity" class="purchase-input" readonly>
                    </td>

                    <td>
                        <span class="delete-btn border-0 bg-transparent" style="cursor: pointer;"><i class="fa-solid fa-trash text-danger px-3 py-2 fs-6"><input type="checkbox" class="godown_deleteId px-2" style="display: none;"  name="{{form.prefix}}-DELETE" id="id_{{form.prefix}}-DELETE" value="" ></i></span>
                    </td>  
                </tr>
                {% endif %}
            

            {% endfor %}

        </tbody>
    </table>

        
 
    <button type="submit" class="ms-3 newProductCreateBtn" id="parentFormClick">Generate</button>
</form>

<div id="customModal" style="display:none; position:fixed; top:0; left:0; height:100%; background:rgba(34, 34, 34, 0.9); display:flex; align-items:center; justify-content:center;">
    <img id="modalImg" style="max-width:60%; max-height:60%; cursor:pointer;">
</div>

<div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="staticBackdropLabel">PickList Products</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <table class="table table-bordered " id="picklistProductTable">
                <thead class="name_absolute">
                    <tr>
                        <th>Model Name</th>
                        <th>Sku</th>
                        <th>Color</th>
                        <th>Qty</th>
                        <th>Balance</th>
                       
                    </tr>
                </thead>
                <tbody class="mainTableList">

                </tbody>
            </table>
        </div>
        <div class="modal-footer">
          <button type="button" class="filterButton" data-bs-dismiss="modal">Close</button>
        
        </div>
      </div>
    </div>
  </div>



<script>

$(document).ready(function () {
    // Event listener for when the picklist number is entered
    $('#id_pickList_no').on('blur', function () { 
        var picklistNo = parseInt($(this).val(), 10);
        var picklistTable = $('#picklistTable .mainTableList tr');
        var picklistExists = false; 
        let rowToPopulate = null;
        
        // ✅ Step 1: Check if the picklist already exists
        picklistTable.each(function () {
            var picklistId = $(this).find('.pickId').val()?.trim();
            if (picklistId == picklistNo) {
                picklistExists = true;
                return false; // Exit loop early
            }
        });

        if (picklistExists) {
            alert('Picklist already used');
            $('#id_pickList_no').val('');
            return;
        }

        $.ajax({
            url: '/outwardpicklistnoajax/',
            method: 'GET',
            data: { "picklistNo": picklistNo },
            success: function (response) {
                var productPickList = response.picklistDict;
                console.log(response)
                if (response.picklistDict && response.picklisQty !== null) {

                    var picklistKey = Object.keys(response.picklistDict)[0]; // Get the first key dynamically

                        var picklistData = response.picklistDict[picklistKey]; // Get the data for that key

                        // Retrieve existing data from the hidden field or initialize empty array
                        var hiddenData = $('#picklistHiddenData').val();
                        var currentData = hiddenData ? JSON.parse(hiddenData) : {};

                        if (!Array.isArray(currentData[picklistKey])) {
                            currentData[picklistKey] = []; // Initialize as empty array if it doesn't exist
                        }

                        // Append all items to the array
                        picklistData.forEach(item => {
                            currentData[picklistKey].push({
                                sku: item.sku,
                                model_name: item.model_name,
                                color: item.color,
                                qty: item.qty
                            });
                        });

                        // Update the hidden input field with the new data
                    $('#picklistHiddenData').val(JSON.stringify(currentData));

                    var tables = $('#picklistTable .mainTableList');

                    // ✅ Step 2: Check if there is an empty row
                    tables.find('tr').each(function () {
                        const row = $(this);
                    
                        if (row.find('.pickId').val()?.trim() === "") {
                            rowToPopulate = row;
                            return false; // Stop looping once an empty row is found
                        }
                    });
    
                    if (rowToPopulate) {
                        populatePicklistRow(rowToPopulate, response);
                        
                    } else {
                        console.log('test')
                        addpickListRow();
                        const newRow = tables.find('tr').last();
                        populatePicklistRow(newRow, response)
                    
                    }
                }
            },
            error: function (error) {
                console.log(error);
            }
        });

        $('#id_pickList_no').val('');
    });

    function populatePicklistRow(row, response){
        row.find('.picklistId').val(response.id);
        row.find('.pickId').val(response.picklistNo);
        row.find('.pickQty').val(response.picklisQty)
        row.find('.pickBalance').val('');
    }

    // onclick picklistqty modal will open and change the sku type qty with balance
    $(document).on('click', 'input.outwardPick-btn', function () {
        var productTable = $('#picklistProductTable .mainTableList');
        productTable.empty();

        var productKey = $(this).closest('tr').find('.pickId').val()?.trim();
        var storedData = $('#picklistHiddenData').val();
        var updateValue = $('#picklistupdateData').val();

        if (updateValue) {
            // ✅ Replace single quotes with double quotes
            var latestUpdate = updateValue.replace(/'/g, '"');
          
            latestUpdate = latestUpdate.replace(/(\d+):/g, '"$1":');  // ✅ Convert numeric keys (like 124) into string keys ("124")
        }

        function safeParseJSON(jsonString) {
            try {
                if (!jsonString || jsonString.trim().toLowerCase() === "none") return {}; // ✅ Convert 'None' to {}
                return JSON.parse(jsonString);
            } catch (error) {
                console.error("Invalid JSON format:", jsonString, error);
                return {}; // ✅ Return empty object instead of crashing
            }
        }

        // ✅ Parse JSON safely
        var parsedData = safeParseJSON(storedData);
        var parsedUpdateData = safeParseJSON(latestUpdate);

        // ✅ If both parsedData and parsedUpdateData are empty, stop execution
        if ($.isEmptyObject(parsedData) && $.isEmptyObject(parsedUpdateData)) {
            console.log("No picklist data found.");
            return;
        }

        // ✅ Merge data only if both exist, otherwise use the available one
        var mergedData = (!$.isEmptyObject(parsedData) && !$.isEmptyObject(parsedUpdateData))
            ? { ...parsedData, ...parsedUpdateData }
            : (!$.isEmptyObject(parsedData) ? parsedData : parsedUpdateData);

        console.log("Final Picklist Data:", mergedData);

        // ✅ Ensure productKey exists in valid data
        if (!mergedData.hasOwnProperty(productKey)) {
            console.warn("No data found for this picklistNo:", productKey);
            return;
        }

        var totalQty = {};
        var picklistSelected = false;

        $('[name$="-product"]').each(function () {
            let row = $(this).closest('tr');
            console.log('row',row,row.length)
            if (row.css('display') === 'none') return; // Skip hidden rows

            var skuElement = $(this).val();
            if (!skuElement) {
                console.warn("SKU is missing for row:", row);
                return; // ✅ Skip rows where SKU is missing
            }

            let sku = String(skuElement).trim();
            console.log('SKU:', sku);

            var pickNos = row.find('[name^="picklistNo_"]').val()?.trim();
            var qty = parseInt(row.find('[name$="-quantity"]').val()) || 0;
            var checkboxChecked = row.find('.picklistRadio').is(':checked');

            if (checkboxChecked) picklistSelected = true;

            if (!pickNos || pickNos !== productKey) return;

            if (!Object.prototype.hasOwnProperty.call(totalQty, sku)) {
                    totalQty[sku] = 0;
                }
                totalQty[sku] += qty;
        });

        console.log('totalQty:', totalQty);

        // ✅ Ensure `mergedData[productKey]` is valid before looping
        if (!Array.isArray(mergedData[productKey])) {
            console.warn("Invalid or missing picklist data for productKey:", productKey);
            return;
        }

        mergedData[productKey].forEach(item => {
            if (!item.sku || !item.qty) {
                console.warn("Skipping invalid item:", item);
                return;
            }

            let sku = String(item.sku).trim();
            let qty = item.qty;
            let outwardQty = picklistSelected ? (totalQty.hasOwnProperty(sku) ? totalQty[sku] : 0) : 0;
            let balanceQty = picklistSelected ? Math.max(0, item.qty - outwardQty) : item.qty;

            console.log('Processing SKU:', sku);
            console.log('Outward Qty:', outwardQty);
            console.log('Balance Qty:', balanceQty);

            var newRow = $(`
                <tr class="picklistRow" data-sku="${sku}" data-picklistno="${productKey}">
                    <td><span class="modelName">${item.model_name || "N/A"}</span></td>
                    <td><span class="sku">${sku}</span></td>
                    <td><span class="color">${item.color || "N/A"}</span></td>
                    <td><span class="qty text-center">${qty}</span></td>
                    <td><span class="balanceqty text-center">${balanceQty}</span></td> 
                </tr>
            `);

            productTable.append(newRow);
        });

    });


    function addpickListRow() {
        const tableBody = document.querySelector('#picklistTable .mainTableList');
        let lastVisibleRow = null;
            console.log('test')
        // Find the last visible row
        tableBody.querySelectorAll('tr').forEach(row => {
            if (window.getComputedStyle(row).display !== 'none') {
                lastVisibleRow = row;
            }
        });

        if (!lastVisibleRow) {
            console.error("No visible row found to clone.");
            return;
        }

        const formCountInput = document.getElementById("id_picklist_process_in_outward_set-TOTAL_FORMS");
        const formCount = parseInt(formCountInput.value, 10);
        const formIndex = formCount;
        
        // Clone last row
        const lastRow = lastVisibleRow.cloneNode(true);

            // Reset all input/select values inside the cloned row
            lastRow.querySelectorAll("input, select").forEach(function (e) {
                e.value = "";
            });

            // Ensure elements exist before modifying them
            const picklistElement = lastRow.querySelector('[name$="-picklist"]');
            if (picklistElement) {
                picklistElement.id = `id_picklist_process_in_outward_set-${formIndex}-picklist`;
                picklistElement.name = `picklist_process_in_outward_set-${formIndex}-picklist`;
                picklistElement.value = "";
            }

            const picklistIdElement = lastRow.querySelector('[name$="-pickId"]');
            if (picklistIdElement) {
                picklistIdElement.id = `id_picklist_process_in_outward_set-${formIndex}-pickId`;
                picklistIdElement.name = `picklist_process_in_outward_set-${formIndex}-pickId`;
                picklistIdElement.value = "";
            }
            const pickListNoElement = lastRow.querySelector('input[name$="-picklistNo"]');
            if (pickListNoElement) {
                pickListNoElement.id = `id_picklist_process_in_outward_set-${formIndex}-picklistNo`;
                pickListNoElement.name = `picklist_process_in_outward_set-${formIndex}-picklistNo`;
                pickListNoElement.value = "";
            }
            const inputSelectElement = lastRow.querySelector('input[name$="-picklistQty"]');
            if (inputSelectElement) {
                inputSelectElement.id = `id_picklist_process_in_outward_set-${formIndex}-picklistQty`;
                inputSelectElement.name = `picklist_process_in_outward_set-${formIndex}-picklistQty`;
                inputSelectElement.value = "";
            }

            const inputElement = lastRow.querySelector('input[name$="-balance_qty"]');
            if (inputElement) {
                inputElement.id = `id_picklist_process_in_outward_set-${formIndex}-balance_qty`;
                inputElement.name = `picklist_process_in_outward_set-${formIndex}-balance_qty`;
                inputElement.value = "";
            }

            const checkboxElement = lastRow.querySelector('input[name^="picklist_group"]');
            if (checkboxElement) {
                checkboxElement.checked = false;
            }

            // Update form count
            formCountInput.value = formCount + 1;

            // Append new row to table
            tableBody.appendChild(lastRow);
    }

    
});

// image priview on click on image 
document.body.appendChild(document.getElementById('staticBackdrop'));
document.body.appendChild(document.getElementById('customModal'));
    function showLargeImage(src) {
     let modal = document.getElementById("customModal");
     let modalImg = document.getElementById("modalImg");

     modalImg.src = src;
     modal.style.display = "flex";
     modal.style.width = '100%'
     // Clicking anywhere outside the image will close the modal
     modal.onclick = function() {
         modal.style.display = "none";
     };
 }
</script>
<script>

$(document).ready(function () {
    let debounceTimeout;

    $('#inwordSerialNo').on('input', function () {
        clearTimeout(debounceTimeout);
        const manual_serial = $('#id_manualSerialNo');
        manual_serial.val('');

        const responseMessage = $('#responseMessage');
        responseMessage.html(''); // Clear any previous messages

        const inputField = $(this);

        debounceTimeout = setTimeout(async function () {
            let inputUrl = inputField.val();
            let serialNo = '';

            if (inputUrl.includes('=')) {
                serialNo = inputUrl.split('=').pop();
                inputField.val(serialNo);
                inputField.css('color', 'black');
            }

            if (serialNo) {
                try {
                    const response = await sendSerialNumber(serialNo);
                    $('#responseMessage').html('<span class="text-success" role="alert">' + response.message + '</span>');
                } catch (error) {
                    // const errorMessage = error.responseJSON?.error || 'An unexpected error occurred.';
                    // $('#responseMessage').html('<span class="text-danger">' + errorMessage + '</span>');
                }
            }
        }, 500);
    });

    $('#id_manualSerialNo').on('input', function () {
           // Clear inwordSerialNo
           $('#inwordSerialNo').val('');
   
           const responseMessage = $('#responseMessage');
           responseMessage.html(''); // Clear any previous messages

       });

    $('#id_manualSerialNo').on('keydown', async function (event) {
        if(event.key === 'Enter'){
            event.preventDefault();
            const manualSerialNo = $('#id_manualSerialNo').val();
            const responseMessage = $('#responseMessage'); // Response message container
                if (manualSerialNo) {
                    try {
                        const response = await sendSerialNumber(manualSerialNo);
                        
                        $('#responseMessage').html('<span class="text-success" role="alert">' + response.message + '</span>');
                        $('#id_manualSerialNo').val('');
                        
                    } catch (error) {
                        // const errorMessage = error.responseJSON?.message || 'An unexpected error occurred.';
                        // $('#responseMessage').html('<span class="text-danger">' + errorMessage + '</span>');
                        $('#id_manualSerialNo').val('');
                    }
                } else {
                    $('#responseMessage').html('<span class="text-danger">Please enter a Manual Serial Number.</span>');
                    $('#id_manualSerialNo').val('');
                }   
        }
    });

    function populateRow(row, productResponse) {
      
        row.find('[name$="-product_RefNo"]').val(productResponse[0]);
        row.find('[name$="-product_name_value"]').val(productResponse[2]);
        row.find('[name^="product_color_"]').val(productResponse[3]);
        row.find('[name$="-product"]').val(productResponse[1]);
        row.find('[name$="-unique_serial_no"]').val(productResponse[4]);
        row.find('[name$="-bin_number"]').val(productResponse[8]);
        row.find('[name$="-bin_no"]').val(productResponse[5])
        row.find('[name$="-quantity"]').val(productResponse[6]);
        row.find('[id^="product_img_"]').attr("src", productResponse[7]);
        row.find('[name^="picklistNo_"]').val(productResponse[9]);

        picklistQtyCheck();
    }

    function picklistQtyCheck() {
        var checkedRadio = $('.picklistRadio:checked');

        if (checkedRadio.length === 0) {
            console.warn("No picklist selected.");
            $('#responseMessage').html('<span class="text-danger">Please select a picklist before calculating.</span>');
            return;
        }

        var storedData = $('#picklistHiddenData').val();
        var updateData = $('#picklistupdateData').val();

        if (updateData) {
            // ✅ Replace single quotes with double quotes
            var latestUpdate = updateData.replace(/'/g, '"');

            // ✅ Convert numeric keys (like 124) into string keys ("124")
            latestUpdate = latestUpdate.replace(/(\d+):/g, '"$1":');
        
        
        }
        function safeParseJSON(jsonString) {
                try {
                    if (!jsonString || jsonString.trim().toLowerCase() === "none") return {}; // ✅ Convert 'None' to {}
                    return JSON.parse(jsonString);
                } catch (error) {
                    console.error("Invalid JSON format:", jsonString, error);
                    return {}; // ✅ Return empty object instead of crashing
                }
            }


        var parsedUpdateData = safeParseJSON(latestUpdate);
        var parsedData = safeParseJSON(storedData);

        // ✅ If both parsedData and parsedUpdateData are empty, stop execution
        if ($.isEmptyObject(parsedData) && $.isEmptyObject(parsedUpdateData)) {
            console.log("No picklist data found.");
            return;
        }

        // ✅ Merge data only if both exist, otherwise use the available one
        var mergedData = (!$.isEmptyObject(parsedData) && !$.isEmptyObject(parsedUpdateData))
            ? { ...parsedData, ...parsedUpdateData }
            : (!$.isEmptyObject(parsedData) ? parsedData : parsedUpdateData);

        var selectedRow = checkedRadio.closest('tr'); 
        var pickNo = parseInt(selectedRow.find('.pickId').val()?.trim(), 10) || 0;
        var pickQty = parseInt(selectedRow.find('.pickQty').val()?.trim(), 10) || 0;
        var pickbalance = parseInt(selectedRow.find('.pickBalance').val()?.trim(), 10)
        var picklistId = selectedRow.find('[name$="-pickId"]').val()?.trim();

        if (!pickNo) {
            console.warn("Picklist number is missing.");
            $('#responseMessage').html('<span class="text-danger">Invalid Picklist No.</span>');
            return;
        }

        var total = 0;
        var serialNoQty = $('[name$="-quantity"]'); // All outward qty inputs

        serialNoQty.each(function () {
            var outwardQty = parseInt($(this).val(), 10) || 0;
            var row = $(this).closest('tr');
            if (row.css('display') === 'none') return; // Skip hidden rows
            var tablePicklistNo = parseInt(row.find('[name^="picklistNo_"]').val()) || 0;
            var tableSku = String(row.find('[name$="-product"]').val()).trim(); // Ensure SKU is string

            if (pickNo === tablePicklistNo) {
                if (mergedData.hasOwnProperty(pickNo)) {
                    let picklistItems = mergedData[pickNo];
                    let matchingItem = picklistItems.find(item => String(item.sku).trim() === tableSku);

                    if (matchingItem) {
                        total += outwardQty; // Add outward quantity
                    } else {
                        console.warn(`SKU ${tableSku} not found in mergedData for Picklist ${pickNo}`);
                    }
                } else {
                    console.warn(`Picklist No ${pickNo} not found in mergedData`);
                }
            }
        });
        var pickBal;
        console.log('total', total);
        console.log('pickQty', pickQty);
        console.log('pickbalance',pickbalance)
        console.log('picklistId',picklistId)

        if(picklistId !== 'None'){
            pickBal = pickbalance - 1;
        }else{
            pickBal = pickQty - total;
        }
         

        if (total === 0) {
            console.warn("Total outward quantity is zero.");
            $('#responseMessage').html('<span class="text-warning">Total outward quantity must be greater than zero.</span>');
            return;
        }

        if (total > pickQty) {
            console.warn("Total outward quantity exceeds picklist quantity.");
            $('#responseMessage').html('<span class="text-danger">Outward quantity cannot be greater than picklist quantity.</span>');
            return;
        }

        selectedRow.find('.pickBalance').val(pickBal);
    }

async function sendSerialNumber(serialNo) {
    var checkedRadio = $('.picklistRadio:checked');
    console.log('checkedRadio',checkedRadio)
    if (checkedRadio.length === 0) {
        console.warn("No picklist selected.");
        $('#responseMessage').html('<span class="text-danger">Please select a picklist before scanning.</span>');
        return;
    }

    // Get the Picklist ID from the selected row
    var selectedRow = checkedRadio.closest('tr');
    var pickNo = parseInt(selectedRow.find('.pickId').val()?.trim(), 10) || 0;
    var pickQty = parseInt(selectedRow.find('.pickQty').val()?.trim(), 10) || 0;
    var pickBalance = parseInt(selectedRow.find('.pickBalance').val().trim(),10) ;
    console.log("Picklist:", pickNo, "Qty:", pickQty, "Balance:", pickBalance);

    try {
        const response = await $.ajax({
            url: '/outwardscanserialnoprocess/',
            type: 'GET',
            data: { serialNo: serialNo, pickNo: pickNo },
        });

        if (!response.products || response.products.length === 0) {
            console.error("No products data found in response.");
            $('#responseMessage').html('<span class="text-danger">No product found for this serial number.</span>');
            return;
        }

        const productResponse = response.products[0];
        const sku = String(productResponse[1]).trim();
        const serialNoResponse = String(productResponse[4]).trim();
        const responsePicklistNo = parseInt(productResponse[9], 10);
        const itemQty = parseInt(productResponse[6], 10) || 0;

        var storedData = $('#picklistHiddenData').val()
        var updateValue = $('#picklistupdateData').val();

        if (updateValue) {
            // ✅ Replace single quotes with double quotes
            var latestUpdate = updateValue.replace(/'/g, '"');

            // ✅ Convert numeric keys (like 124) into string keys ("124")
            latestUpdate = latestUpdate.replace(/(\d+):/g, '"$1":');
        }

        function safeParseJSON(jsonString) {
            try {
                if (!jsonString || jsonString.trim().toLowerCase() === "none") return {}; // ✅ Convert 'None' to {}
                return JSON.parse(jsonString);
            } catch (error) {
                console.error("Invalid JSON format:", jsonString, error);
                return {}; // ✅ Return empty object instead of crashing
            }
        }

        // ✅ Parse JSON safely
        var parsedData = safeParseJSON(storedData);
        var updateData = safeParseJSON(latestUpdate);


        // ✅ Merge data only if both exist, otherwise use the available one
        var mergedData = (!$.isEmptyObject(parsedData) && !$.isEmptyObject(updateData))
            ? { ...parsedData, ...updateData }
            : (!$.isEmptyObject(parsedData) ? parsedData : updateData);

        if (pickNo !== responsePicklistNo) {
            console.error("Picklist No mismatch!");
            $('#responseMessage').html('<span class="text-danger">Product not available in picklist.</span>');
            return;
        }

        if (!mergedData.hasOwnProperty(pickNo)) {
            console.error("Picklist No not found in stored data.");
            $('#responseMessage').html('<span class="text-danger">Invalid Picklist No.</span>');
            return;
        }

        let picklistItems = mergedData[pickNo];
        let matchingItem = picklistItems.find(item => String(item.sku).trim() === sku);

        if (!matchingItem) {
            console.error("SKU does not match the selected Picklist.");
            $('#responseMessage').html('<span class="text-danger">SKU mismatch! This item is not in the picklist.</span>');
            return;
        }

        if (pickBalance < 1) {
            console.error("No stock available. Balance is zero.");
            $('#responseMessage').html('<span class="text-danger">Balance is zero. Cannot scan this product.</span>');
            return;
        }

        let isDuplicate = false;
        let rowToPopulate = null;

        $('#outwardSales .mainTableList tr').each(function () {
            const row = $(this);
            if (row.css('display') === 'none') return;

            const serialValue = row.find('[name$="-unique_serial_no"]').val()?.trim();
            if (serialValue && serialValue === serialNo) {
                $('#responseMessage').html('<span class="text-danger">Duplicate Serial Number.</span>');
                isDuplicate = true;
                return false;
            }

            if (!isDuplicate && row.find('[name$="-product_name_value"]').val()?.trim() === "") {
                rowToPopulate = row;
                return false;
            }
        });

        if (isDuplicate) return;

        if (rowToPopulate) {
            populateRow(rowToPopulate, productResponse);
        } else {
            addNewRow();
            const newRow = $('#outwardSales .mainTableList tr').last();
            populateRow(newRow, productResponse);
        }

    } catch (error) {
        console.error("Error sending serial number:", error);
        $('#responseMessage').html('<span class="text-danger">Error processing request.</span>');
    }
}




    function isTableEmpty() {
   
    return $('#outwardSales .mainTableList tr').toArray().every(row => isRowEmpty($(row)));
      }

      function isRowEmpty(row) {
          return row.find('td :input').filter(function () {
              return $(this).val().trim() !== "";
          }).length === 0;
      }


    function addNewRow() {
        const tableBody = document.querySelector('#outwardSales .mainTableList');

        tableBody.querySelectorAll('tr').forEach(row => {
            if (window.getComputedStyle(row).display !== 'none') {
                lastVisibleRow = row;
            }
        });

        const formCountInput = document.getElementById("id_outward_product-TOTAL_FORMS");
        const formCount = parseInt(formCountInput.value);
        const formIndex = formCount;
        const lastRow = lastVisibleRow.cloneNode(true);
        lastRow.querySelectorAll("input select").forEach(function (e) {
            e.value = "";
        });

        // Update the input name, id, and value of the last row
        const rowElement = lastRow.querySelector('.rowNo[name^="rowNo_"]');
        rowElement.id = `rowNo_${formIndex}`;
        rowElement.name = `rowNo_${formIndex}`;
        rowElement.value = formIndex + 1;
        rowElement.style.border = "none";
 
        const picklistElement = lastRow.querySelector('[name^="picklistNo_"]')
        picklistElement.id = `id_picklistNo_${formIndex}`;
        picklistElement.name = `picklistNo_${formIndex}`;
        picklistElement.value = "";

        const inputSelectElement = lastRow.querySelector('input[name$="-product_RefNo"]');
        inputSelectElement.id = `id_outward_product-${formIndex}-product_RefNo`;
        inputSelectElement.name = `outward_product-${formIndex}-product_RefNo`;
        inputSelectElement.value = "";

        const inputElement = lastRow.querySelector('input[name$="-product_name_value"]');
        inputElement.id = `id_outward_product-${formIndex}-product_name_value`;
        inputElement.name = `outward_product-${formIndex}-product_name_value`;
        inputElement.value = "";

        const colorInputElement = lastRow.querySelector('.purchase-input[name^="product_color"]');
        colorInputElement.id = `product_color_${formIndex}`;
        colorInputElement.name = `product_color_${formIndex}`;
        colorInputElement.value = "";

        const skuInputElement = lastRow.querySelector('.purchase-amount[name$="-product"]');
        skuInputElement.id = `id_outward_product-${formIndex}-product`;
        skuInputElement.name = `outward_product-${formIndex}-product`;
        skuInputElement.value = "";

        const imgElement = lastRow.querySelector('[id^="product_img_"]');
        imgElement.id = `product_img_${formIndex}`;
        imgElement.src = "";

        const serialNoElement = lastRow.querySelector('input[name$="-unique_serial_no"]');
        serialNoElement.id = `id_outward_product-${formIndex}-unique_serial_no`;
        serialNoElement.name = `outward_product-${formIndex}-unique_serial_no`;
        serialNoElement.value = '';

        const binNameElement = lastRow.querySelector('input[name$="-bin_number"]');
        binNameElement.id = `id_outward_product-${formIndex}-bin_number`;
        binNameElement.name = `outward_product-${formIndex}-bin_number`;
        binNameElement.value = '';

        const binNoElement = lastRow.querySelector('input[name$="-bin_no"]');
        binNoElement.id = `id_outward_product-${formIndex}-bin_no`;
        binNoElement.name = `outward_product-${formIndex}-bin_no`;
        binNoElement.value = '';


        const qunatityInputElement = lastRow.querySelector('[name$="-quantity"]');
        qunatityInputElement.id = `id_outward_product-${formIndex}-quantity`;
        qunatityInputElement.name = `outward_product-${formIndex}-quantity`; 
        qunatityInputElement.value="";


        formCountInput.value = formCount + 1;
        tableBody.appendChild(lastRow);
        deleteRowData();
        inputCheck()
    }

    function getVisibleRows() {
        // Select all rows that are not hidden (excluding those with display: none)  
        return document.querySelectorAll('.mainTableList tr:not([style*="display: none"])');;
    }

       function deleteRowData(){
        // Add click event listener to all delete buttons
        document.querySelectorAll('.delete-btn').forEach(function (button) {
            button.addEventListener('click', function () {
                // Find all rows in the table
                const rows =  getVisibleRows();
              
                if (rows.length > 1) {
                    const row = this.closest('tr');
        
                    if (row) {
                        const checkRow = row.querySelector('.godown_deleteId[name$="-DELETE"]');
        
                        if (checkRow) {
                            checkRow.checked = true; 
                            checkRow.value = 'true'; 
                            row.style.display = 'none';
                            
                            var checkedRadio = $('.picklistRadio:checked');

                            if (checkedRadio.length === 0) {
                                console.warn("No picklist selected.");
                                $('#responseMessage').html('<span class="text-danger">Please select a picklist before calculating.</span>');
                                return;
                            }
                

                            var selectedRow = checkedRadio.closest('tr'); // Get the selected row
                            var pickNo = parseInt(selectedRow.find('.pickId').val().trim(), 10); // Selected Picklist No.
                            var pickQty = parseInt(selectedRow.find('.pickQty').val().trim(), 10) || 0; // Selected Picklist Quantity


                            recalculatePicklistBalances(selectedRow,pickNo ,pickQty);
        
                            inputCheck();
                            //picklistQtyCheck()
                            
                        } else {
                            console.error("Checkbox for deletion not found in this row");
                        }
                    }
                } else {
                    // If only one row remains, alert the user
                    alert('Cannot delete this row; at least one row must remain.');
                }
            });
        }); 
    }

    function recalculatePicklistBalances(selectedRow,pickNo,pickQty) {
        var productTable = $('#picklistProductTable .mainTableList');
        productTable.empty();
        let storedData = $('#picklistHiddenData').val();
        if (!storedData) return;

        let parsedData = JSON.parse(storedData);
        console.log('parsedData',parsedData)
        let totalQty = {};
        var picklistSelected = false; 

        // ✅ Only include visible rows in calculation
        $('[name$="-product"]').each(function () {
            let row = $(this).closest('tr');
            if (row.css('display') === 'none') return; // Skip hidden rows
            var checkboxChecked = row.find('.picklistRadio'); 
            let sku = String($(this).val()).trim();
            let pickNos = row.find('[name^="picklistNo_"]').val()?.trim();
            let qty = parseInt(row.find('[name$="-quantity"]').val()) || 0;

            if (checkboxChecked) picklistSelected = true; // At least one checkbox is selected

            // if (!pickNos || pickNos !== pickNo) return; // Skip if picklist doesn't match
            console.log('sku',sku)
            console.log('pickNos',pickNos)
            console.log('qty',qty)
    

            if (!totalQty[sku]) {
                totalQty[sku] = 0;
            }
            totalQty[sku] += qty; // Accumulate quantity per SKU
        
        });
        console.log('totalQty',totalQty)
        // ✅ Update balance quantities only for visible rows
        console.log("Executing balance update function...");
        console.log(selectedRow)
        
        parsedData[pickNo].forEach(item => {
            let sku = String(item.sku).trim(); // Ensure SKU is a string
            let qty = item.qty;
            console.log(`✅ SKU: ${sku},  Qty: ${qty}`);
            let outwardQty = picklistSelected ? (totalQty[String(sku)] ?? 0) : 0; // Ensure correct lookup
            let balanceQty = picklistSelected ? Math.max(0, item.qty - outwardQty) : item.qty; 
            console.log(`✅ SKU: ${sku}, Outward Qty: ${outwardQty}, Balance Qty: ${balanceQty}`);

            selectedRow.find('.pickBalance').val(balanceQty)
        })
}

      //deleteRowData()
     function inputCheck(){
        document.getElementById('id_outward_no').focus();
       
        const outwardNo = document.getElementById('id_outward_no');
        const inwardNo = document.getElementById('inwordSerialNo');
        const mscanNo = document.getElementById('id_manualSerialNo')
        const submit = document.getElementById('parentFormClick')
        if(outwardNo){
            outwardNo.addEventListener('keydown',function(event){
                if(event.key === "Tab"){
                    event.preventDefault()
               
                    if(outwardNo.value === ''){
                 
                        outwardNo.focus();
                        return;
                    }else{
                        inwardNo.focus() ;
                    }
                  
                }
            })
        }
        
        if(inwardNo){
            inwardNo.addEventListener('keydown', function(event) {
                if (event.key === "Tab") {
                    event.preventDefault();
              
                    if (inwardNo.value === '' ) {
                        inwardNo.focus();
                        return;
                        
                    }  
                }
            })  
        }
        if(mscanNo){
            mscanNo.addEventListener('keydown', function(event) {
                if (event.key === "Tab") {
                    event.preventDefault();
              
                    if (mscanNo.value === '' ) {
                        mscanNo.focus();
                        return;
                        
                    }else{
                        submit.focus();
                    }  
                }
            })
        }
        
        }
    
        inputCheck();

 })

 
</script>


{% endblock body %}