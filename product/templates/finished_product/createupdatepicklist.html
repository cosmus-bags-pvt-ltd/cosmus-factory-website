{% extends 'product/base.html' %}
{% load static %}
{% block body %}
<div class="mt-3">
    <form action="" method="POST">
        {% csrf_token %}
        <div class="d-flex mb-2">
            <label for="id_picklist_no" class="me-3">PickList No :</label>
            {% if master_form.instance.id %}
            <input type="text" class="purchase-input" name="picklist_no" id="id_picklist_no" value="{{master_form.instance.picklist_no}}" maxlength="255" readonly>
            {% elif not master_form.instance.id %}
            <input type="text" class="purchase-input" name="picklist_no" id="id_picklist_no" value="{{master_form.picklist_no.initial }}" maxlength="255" required>
            {% endif %}

            <label for="pickListDate" class="ms-3 me-3">Date :</label>
            <input type="date" class="item-selects" name="" id="pickListDate" >
        </div>
        <div>
            <table class="table table-striped table-hover table-bordered" id="createpickListTable">
                <thead>
                    <tr>
                        <th>No</th>
                        <th>Ref No</th>
                        <th>Model Name</th>
                        <th>Color</th>
                        <th>Sku</th>
                        <th>Images</th>
                        <th>Bin</th>
                        <th>Reserve Qty</th>
                        <th>Quantity</th>
                        <th>Delete</th>
                    </tr>
                </thead>
                <tbody class="mainTableList">
                    {{ formset.management_form }}
                    {% for form in formset %}
                    {{form.id}}
                    <tr>
                        <td><input type="number" class="rowNo" name="rowNo_{{forloop.counter0}}" id="rowNo_{{forloop.counter0}}" value="{{forloop.counter}}"></td>
                        <td><input type="number" name="{{form.prefix}}-product_refNo" class="purchase-amount stock_color" id="id_{{form.prefix}}-product_refNo" value="{% if form.instance.id %}{{form.instance.product.Product.Product_Refrence_ID}}{% endif %}"style="outline:none" readonly></td>
                        {% if form.instance.id %}
                        <td> 
                            <div class="custom-dropdown-container">
                              <input type="hidden" name="{{form.prefix}}-product" id="id_{{form.prefix}}-product"  value="{% if form.instance.id %}{{form.instance.product.PProduct_SKU}}{% endif %}" >

                              <input type="text" name="{{form.prefix}}-product_name_value" id="id_{{form.prefix}}-product_name_Value" class="productpurchaseInvoice search-input"  placeholder="Product Name" autocomplete="off" value="{% if form.instance.id %}{{form.instance.product.Product.Model_Name}} {% endif %}" readonly> 

                              <div name="select_product_name_{{forloop.counter0}}" class="productpurchaseInvoice product-name s-suggestion-container item-select_input" id="select_product_name_{{forloop.counter0}}" style="display: none; height:auto;" dir="auto" spellcheck="false" tabindex="0" aria-label="Product Name" >
                                
                             
                               </div>
                          </div>
                        </td>
                        {% else %}
                        <td> 
                            <div class="custom-dropdown-container">
                              <input type="hidden" name="{{form.prefix}}-product" id="id_{{form.prefix}}-product"  value="{% if form.instance.id %}{{form.instance.product.PProduct_SKU}}{% endif %}" >

                              <input type="text" name="{{form.prefix}}-product_name_value" id="id_{{form.prefix}}-product_name_Value" class="productpurchaseInvoice search-input"  placeholder="Product Name" autocomplete="off" value="{% if form.instance.id %}{{form.instance.product.Product.Model_Name}} {% endif %}" > 

                              <div name="select_product_name_{{forloop.counter0}}" class="productpurchaseInvoice product-name s-suggestion-container item-select_input" id="select_product_name_{{forloop.counter0}}" style="display: none; height:auto;" dir="auto" spellcheck="false" tabindex="0" aria-label="Product Name" >
                                
                             
                               </div>
                          </div>
                        </td>

                        {% endif %}
                        <td><input type="text" name="product_color_{{forloop.counter0}}" id="product_color_{{forloop.counter0}}" value="{{form.instance.product.PProduct_color}}" class="purchase-input" readonly></td>

                        <td><input type="text" name="product_Sku_{{forloop.counter0}}" id="product_Sku_{{forloop.counter0}}" value="{{form.instance.product.PProduct_SKU}}" class="purchase-amount" readonly></td>
                        
                        {% if form.instance.id %}
                        <td><img src="{{form.instance.product.PProduct_image.url}}" id="id_productInward_img_{{forloop.counter0}}" alt="product"  style="width: 30px; height: 30px; cursor: pointer;" onclick="showLargeImage(this.src)"></td>
                        {% else %}
                        <td><img src="" id="id_productInward_img_{{forloop.counter0}}" alt="product" width="30px" height="30px"></td>
                        {% endif %}
                        

                        <td><select name="{{form.prefix}}-bin_number" id="id_{{form.prefix}}-bin_number"  class="purchase-amount" aria-label="Select Bin">
                                {% if form.instance.id %}
                                    <option value="{{form.instance.bin_number.id}}">{{form.instance.bin_number.bin_name}}</option>
                                {% elif not form.instance.id %}
                               
                                {% endif %}
                            </select>
                            
                        </td>
                        <td>
                            <input  type="number" value="" class="purchase-input" name="reserver_Qty_{{forloop.counter0}}" maxlength="200" id="id_reserver_Qty_{{forloop.counter0}}" readonly>
                        </td>
                        {% if form.instance.id %}
                        <td>
                            <input  type="number" value="{{form.instance.product_quantity|default_if_none:''}}" class="purchase-input" name="{{form.prefix}}-product_quantity" maxlength="200" id="id_{{form.prefix}}-product_quantity" readonly>
                            <input type="hidden" class="productQtyValue" name="product_quantity-{{forloop.counter0}}" id="id_product_quantity-{{forloop.counter0}}" value = '' readonly>
                        </td>
                        <td>
                            <span class="delete-btn border-0 bg-transparent" style="display: none;"><i class="fa-solid fa-trash text-danger px-3 py-2 fs-6"><input type="checkbox" class="stock_deleteId px-2" style="display: none;" name="{{form.prefix}}-DELETE" id="id_{{form.prefix}}-DELETE" value="" ></i></span>
                        </td>
                        {% else %}
                        <td>
                            <input  type="number" value="{{form.instance.product_quantity|default_if_none:''}}" class="purchase-input" name="{{form.prefix}}-product_quantity" maxlength="200" id="id_{{form.prefix}}-product_quantity">
                            <input type="hidden" class="productQtyValue" name="product_quantity-{{forloop.counter0}}" id="id_product_quantity-{{forloop.counter0}}" value = ''>
                        </td>
                        <td>
                            <span class="delete-btn border-0 bg-transparent" style="cursor: pointer;"><i class="fa-solid fa-trash text-danger px-3 py-2 fs-6"><input type="checkbox" class="stock_deleteId px-2" style="display: none;" name="{{form.prefix}}-DELETE" id="id_{{form.prefix}}-DELETE" value="" ></i></span>
                        </td>
                        {% endif %}
                        
                    </tr>
                   
                    {% endfor %}
                    
                </tbody>
            </table>
        </div>
        <div class="ms-2 mb-5">
            <!-- <input type="number" class="product_row" name="productRow" id="id_productRow" value="1"> -->
            <button type="button" class="item-btn mb-3" id="addRowButton">Add +</button>
        </div>
        <button type="submit" class="ms-5 newProductCreateBtn" id="picklistSubmit">Submit</button>
    </form>
</div>
<div id="customModal" style="display:none; position:fixed; top:0; left:0; height:100%; background:rgba(34, 34, 34, 0.9); display:flex; align-items:center; justify-content:center;">
    <img id="modalImg" style="max-width:60%; max-height:60%; cursor:pointer;">
</div>
<script>
    document.body.appendChild(document.getElementById('customModal'));
    function showLargeImage(src) {
     let modal = document.getElementById("customModal");
     let modalImg = document.getElementById("modalImg");

     modalImg.src = src;
     modal.style.display = "flex";
     modal.style.width = '100%'
     // Clicking anywhere outside the image will close the modal
     modal.onclick = function() {
         modal.style.display = "none";
     };
 }
</script>
<script>
    //This ajax call is to populate the shade and color based on the selected item once retrive the value
    //When click the item name then append the shades with the color, per 
    $(document).ready(function () {
        var itemName;
        var uniqueIdValue;
        var purchaseValue;
        var selectName;
        var searchedProductNameDic; 
        var enterPressed = false;


        // This ajax request for a input type value send to the backend and show the product name 
        $(document).on('input', 'input[name$="-product_name_value"]', function(e) {
            var purchaseValue = $(this).attr('name').match(/\d+/)[0]; // Extract the numeric value from the input name
            var productnamevalue = $(this).val().trim();
            var selectNameValue = `select_product_name_${purchaseValue}`;
            var suggestionsContainer = $(`#${selectNameValue}`);
 
                if (productnamevalue === 'None') {
                    var selectNameValue = $(this).closest('tr').find('[name^="select_product_name_"]');
                        
                    selectNameValue.css('display', 'none');
                    $(this).attr('data-key', '');
                    return;
                }

                if(!enterPressed){
                    suggestionsContainer.css('display', 'block');
                }
                enterPressed = false;

                if(productnamevalue.length >= 1){
                    $.ajax({
                    url: '/picklistproductajax/',
                    method: 'GET',
                    data: { 'productnamevalue': productnamevalue },
                    success: function (response) {
                        // Function to escape special characters in the search query
                        function escapeRegExp(string) {
                            return string.replace(/[.*+?^${}()|[\]\\,]/g, '\\$&');
                        }
                        searchedProductNameDic = response.products;
                        console.log('searchedProductNameDic',searchedProductNameDic)
                        const searchQuery = productnamevalue.toLowerCase();
                        const searchTerms = searchQuery.split(/\s+/);
                        const convertStringData = searchTerms.toString();
                    
                        const escapedTerms = searchTerms.map(escapeRegExp);

                        const regex = new RegExp(`(${escapedTerms.join('|')})`, 'gi');

                        const normalizeSpaces = (str) => str.replace(/\s+/g, ' ').trim();
      
                        const filteredOptions = Object.entries(searchedProductNameDic).filter(
                        ([key, value]) => {
                            const normalizedKey = normalizeSpaces(key.toString().toLowerCase());
                            const normalizedProductName = normalizeSpaces(value[0].toString().toLowerCase());
                            const normalizedColor = normalizeSpaces(value[1].toString().toLowerCase());
                        
                            const normalizedQuery = normalizeSpaces(convertStringData.toLowerCase());
           
                            return normalizedKey.includes(normalizedQuery) ||
                                normalizedProductName.includes(normalizedQuery) ||
                                normalizedColor.includes(normalizedQuery);
                        });
         
                        suggestionsContainer.empty();
                        
                        // Generate suggestions for matching options
                        filteredOptions.forEach(([key, value], index) => {
                            // Extract relevant fields
                            const productName = value[0]; // Product name
                            const productSKU = key; // SKU
                            const productColor = value[1];
                            const productQty = value[2];
                            // Highlight matches in name, SKU, and color
                            const highlightedText = productName.replace(regex, '<span class="highlight">$1</span>');
                            const highlightedSKU = productSKU.replace(regex, '<span class="highlight">$1</span>');
                            const highlightedColor = productColor.replace(regex, '<span class="highlight">$1</span>');

                            // Add the suggestion to the container
                            suggestionsContainer.append(`
                                <div id="itemName-div_${index}" class="itemName-div itemName-div-suggestion" data-key="${key}">
                                   ${highlightedText}<span style="padding-left:20px">${highlightedColor}</span> <span style="float:right">${productQty}</span>
                                </div>
                            `);
                        });
                    
                    },
                    error: function (xhr) {
                        console.log(xhr.status + ": " + xhr.responseText);
                        if (xhr.status === 404) {
                            
                            suggestionsContainer.show();
                            suggestionsContainer.empty();
                            suggestionsContainer.append(`<div" class="itemName-div itemName-div-suggestion ">No item found</div>`);
                        }
                    }
                });
                }else{
                    suggestionsContainer.empty();
                }
        
        
            suggestionsContainer.on('click', '.itemName-div', function(e) {
                var item_value = $(this).data('key');
                var itemNamevaluesCheck = $(this).text().trim();
                var productcolorinput = document.querySelector('#product_color_' + purchaseValue);
                var skuIput = document.querySelector('#product_Sku_' + purchaseValue);
                var productRefNo = document.getElementById('id_picklist_products_list-' + purchaseValue + '-product_refNo');                   
                var imgUrl = document.getElementById('id_productInward_img_'+purchaseValue );
                var reserveValue = document.getElementById('id_reserver_Qty_'+ purchaseValue)
       
                $(this).addClass('selected').siblings().removeClass('selected');

                var selectedValue = searchedProductNameDic[item_value];
                const productQty = selectedValue[2];
                const namevalueCheck = selectedValue[0];
                const productColor = selectedValue[1];
                const productRefId = selectedValue[5];
                const productReserve = selectedValue[4];
                const url = selectedValue[6]
                var newnameValue = namevalueCheck + '                                      ' + productQty;

                $(`input[name$="picklist_products_list-${purchaseValue}-product"]`).val(item_value);
                $(`input[name$="picklist_products_list-${purchaseValue}-product_name_value"]`).val(newnameValue)
              

                productcolorinput.value = productColor;
                skuIput.value = item_value;
                productRefNo.value = productRefId;
                imgUrl.src = url;
                reserveValue.value = productReserve;
 
                let totalExistingQuantity = 0;
                
                    $('input[name^="picklist_products_list-"][name$="-product"]').each(function () {
                    var rowProductValue = parseInt($(this).val());
                    var rowIndex = $(this).attr('name').match(/\d+/)[0]; // Extract index
                  
                    if (rowProductValue === item_value) {
                        var rowQuantity = parseInt($(`input[name="picklist_products_list-${rowIndex}-product_quantity"]`).val()) || 0;
                        totalExistingQuantity += rowQuantity;
        
                        $(`input[name="product_quantity-${rowIndex}"]`).val(totalExistingQuantity)
                    }
          
                })

                const selectBin = selectedValue[3]; 
                console.log(selectBin)

                initalBinData(selectBin,purchaseValue,productReserve)

                suggestionsContainer.css('display', 'none');
                
            });
        });


        $(document).on('focusout', 'input[name$="-product_quantity"]', function(e){
          
            let rowIndex = $(this).attr("id").match(/\d+/)[0];  // Extract row index
            let productQty = parseInt($(`#id_picklist_products_list-${rowIndex}-product_quantity`).val())|| 0;
            let sku = $(`#id_picklist_products_list-${rowIndex}-product`).val();
            let binName = $(`#id_picklist_products_list-${rowIndex}-bin_number`).val();
            let binQty = parseInt($(`#id_picklist_products_list-${rowIndex}-bin_number option:selected`).attr('data-quantity'));
            let reserveQty = parseInt($(`#id_reserver_Qty_${rowIndex}`).val());
            console.log('binQty',binQty)
            console.log('productQty',productQty)
            if(productQty > binQty){
               $(`#id_picklist_products_list-${rowIndex}-product_quantity`).val(binQty) 
            }
            // Sending all rows data via AJAX
            $.ajax({
                url: '/binquantityajax/',
                method: 'GET',
                data: { 
                "sku": sku,
                "binName": binName,
                "binQty":binQty,
                "productQty": productQty,
                "reserveQty": reserveQty
                    },  // Send as JSON string
                success: function (response) {
                    console.log(response);
                },
                error: function (error) {
                    console.log(error);
                }
            });
        })

        function initalBinData(selectBin,purchaseValue,productReserve){
      
            if (selectBin) {
                var productSelectBin = $(`#id_picklist_products_list-${purchaseValue}-bin_number`);
                var productmainQty = parseInt($(`#id_product_quantity-${purchaseValue}`).val());
                let skucurrent = $(`input[name="product_Sku_${purchaseValue}"]`).val();
                var selectNameValue = `select_product_name_${purchaseValue}`;
                var suggestionsContainer = $(`#${selectNameValue}`);
    
                var selectedBins = {}; 
                productSelectBin.empty();
        
                if (productSelectBin) {
            
                    selectBin.forEach(binObject => {
                        Object.entries(binObject).forEach(([binKey, binArray]) => {
                            if (Array.isArray(binArray) && binArray.length === 2) {
                                const [binName, quantity] = binArray;
                                let optionHtml = `<option value="${binKey}" data-quantity ='${quantity}'> 
                                                        ${binName} - ${quantity} 
                                                </option>`;

                                productSelectBin.append(optionHtml);
                                
                            } else {
                                console.error(`Invalid binArray format at key ${binKey}:`, binArray);
                                productSelectBin.empty();
                            }
                        });
                        productSelectBin.find("option:first").prop("selected", true);
                    });

                    
                } 
        
                        

            } else {
                console.error('selectBin is undefined or not iterable.');
            }   

        }
        
        var index = 0; 
        var indexbool = true;

        $(document).on('keydown', 'input[name$="-product_name_value"]', function(event) {
        const $inputField = $(this);
        const $dropdownOptions = $inputField.next('.product-name');
        const $options = $dropdownOptions.find('.itemName-div');
        const optionsCount = $options.length - 1;
        const searchText = $inputField.val().trim();
        const hiddenValue = $inputField.closest('.custom-dropdown-container').find(`#select_item_name_${purchaseValue}`);
        if (searchText === '') {
            index = 0;
            return;
        }
        const newHeight = $inputField.offset();
        const windowHeight = $(window).height();
        const availableSpace = windowHeight - newHeight.top - $inputField.outerHeight();
   

        if (event.key === 'ArrowDown') {
             event.preventDefault();

            if (index <= optionsCount) {
            
                const $selectedItem = $options.eq(index);
                const $nextItem = $selectedItem.next();
                const nameDataKey = $selectedItem.text();
                const nameKey = $selectedItem.data('key');

                $inputField.attr('data-key', nameKey);
             
                $selectedItem.addClass('bg-highlight').siblings().removeClass('bg-highlight');
                const itemOffsetTop = $nextItem.position().top;
                const itemHeight = $nextItem.outerHeight();
                const selectScrollTop = $dropdownOptions.scrollTop();
                const selectHeight = $dropdownOptions.height();

                if (itemOffsetTop + itemHeight > selectHeight) {
                    $dropdownOptions.scrollTop(selectScrollTop + itemHeight);
                } else if (itemOffsetTop < 0) {
                    $dropdownOptions.scrollTop(selectScrollTop - itemHeight);
                }
                $selectedItem.addClass('selected');
                if (index !== optionsCount) {
                    index += 1;
                    indexbool = true;
                }
            } else {
                index = 0;
            }
        }

        if (event.key === 'ArrowUp') {
             event.preventDefault();

            if (index != 0 && indexbool == true) {
                index -= 1;
            }

            if (index <= optionsCount) {
               
                const $selectedItem = $options.eq(index);
                const $prevItem = $selectedItem.prev();
                const nameDataKey = $selectedItem.text();
                const nameKey = $selectedItem.data('key');

                $inputField.attr('data-key', nameKey);
                
                $selectedItem.addClass('bg-highlight').siblings().removeClass('bg-highlight');
                
                const itemOffsetTop = $prevItem.position().top;
                const itemHeight = $prevItem.outerHeight();
                const selectScrollTop = $dropdownOptions.scrollTop();
                const selectHeight = $dropdownOptions.height();

                if (itemOffsetTop < 0) {
                    $dropdownOptions.scrollTop(selectScrollTop - itemHeight);
                } else if (itemOffsetTop + itemHeight > selectHeight) {
                    $dropdownOptions.scrollTop(selectScrollTop + itemHeight);
                }

                $selectedItem.addClass('selected');
            } else {
                index = 0;
            }
        }

        if (event.key === 'Enter') {
             event.preventDefault();
            const itemEnterValue = $(this);
            const item_value = Number(itemEnterValue.attr('data-key'));
            var purchaseValue = itemEnterValue.closest('tr').find('[name^="product_color_"]').attr('name').match(/\d+/)[0];

            nameDataKey = '';
            nameKey = '';
            index = 0;
            indexbool = false;
            $dropdownOptions.css('display', 'none');

                var selectedValue = searchedProductNameDic[item_value];
                const productQty = selectedValue[2];
                const namevalueCheck = selectedValue[0];
                const productColor = selectedValue[1];
                const productRefId = selectedValue[5];
                const productReserve = selectedValue[4];
                const url = selectedValue[6]
               
                var newnameValue = namevalueCheck +'                                  '+productQty;
                $(`input[name$="picklist_products_list-${purchaseValue}-product"]`).val(item_value);
                $(`input[name$="picklist_products_list-${purchaseValue}-product_name_value"]`).val(newnameValue)
              
                  
                
                 var productcolorinput = document.querySelector('#product_color_' + purchaseValue);
                var skuIput = document.querySelector('#product_Sku_' + purchaseValue);
                var productRefNo = document.getElementById('id_picklist_products_list-' + purchaseValue + '-product_refNo');                   
                var imgUrl = document.getElementById('id_productInward_img_'+purchaseValue );
                var reserveValue = document.getElementById('id_reserver_Qty_'+ purchaseValue);

                productcolorinput.value = productColor;
                skuIput.value = item_value;
                productRefNo.value = productRefId;
                imgUrl.src = url;
                reserveValue.value = productReserve;

                let totalExistingQuantity = 0;
                
                    $('input[name^="picklist_products_list-"][name$="-product"]').each(function () {
                    var rowProductValue = parseInt($(this).val());
                    var rowIndex = $(this).attr('name').match(/\d+/)[0]; // Extract index
                  
                    if (rowProductValue === item_value) {
                        var rowQuantity = parseInt($(`input[name="picklist_products_list-${rowIndex}-product_quantity"]`).val()) || 0;
                        totalExistingQuantity += rowQuantity;
        
                        $(`input[name="product_quantity-${rowIndex}"]`).val(totalExistingQuantity)
                    }
          
                })
                var selectBin = selectedValue[3]; 
                initalBinData(selectBin,purchaseValue,productReserve) 
                

            enterPressed = true;
            hiddenValue.css("display" ,"none");
            $inputField.blur();
            
           
        }
        if (event.key === 'Tab' && enterPressed) {
        enterPressed = false; // Reset Enter key handling
        return true; // Allow default Tab behavior
    }
   
     });

  

})

document.addEventListener('DOMContentLoaded', function () {
    const addButton= document.getElementById('addRowButton');
    const tableBody = document.querySelector('#createpickListTable tbody'); // Clone the first row of the table
    
    if(addButton && tableBody){
        addButton.addEventListener('click', function() {
            // let addInputRow = parseInt(document.getElementById('id_productRow').value, 10);

            //     if (isNaN(addInputRow) || addInputRow <= 0) {
            //         addInputRow = 1;
            //         return;
            //     }
                let lastVisibleRow = null;
                tableBody.querySelectorAll('tr').forEach(row => {
                    if (window.getComputedStyle(row).display !== 'none') {
                        lastVisibleRow = row;
                    }
            });

            if (lastVisibleRow) {
                const formCountInput = document.getElementById("id_picklist_products_list-TOTAL_FORMS");
               
                // for(let i = 0; i<addInputRow; i++){
                    const formCount = parseInt(formCountInput.value); 
                    const formIndex = formCount;
                    const lastRow = lastVisibleRow.cloneNode(true);
                    lastRow.querySelectorAll("input select").forEach(function (e) {
                        e.value = "";
                    });

                    // update the input name,id and value of the last row   
                    const rowElement = lastRow.querySelector('.rowNo[name^="rowNo_"]');
                    rowElement.id = `rowNo_${formIndex}`;
                    rowElement.name = `rowNo_${formIndex}`;
                    rowElement.value = formIndex + 1 ;
                    rowElement.style.border="none";

                    const inputRefNo = lastRow.querySelector('input[name$="-product_refNo"]');
                    inputRefNo.id = `id_picklist_products_list-${formIndex}-product_refNo`;
                    inputRefNo.name = `picklist_products_list-${formIndex}-product_refNo`;
                    inputRefNo.value="";

                    const inputSelectElement = lastRow.querySelector('input[name$="-product"]');
                    inputSelectElement.id = `id_picklist_products_list-${formIndex}-product`;
                    inputSelectElement.name = `picklist_products_list-${formIndex}-product`;
                    inputSelectElement.value="";

                    const inputElement = lastRow.querySelector('input[name$="-product_name_value"]');
                    inputElement.id = `id_picklist_products_list-${formIndex}-product_name_value`;
                    inputElement.name = `picklist_products_list-${formIndex}-product_name_value`;
                    inputElement.value="";
                    
                    const selectElement = lastRow.querySelector('.product-name[name^="select_product_name_"]');
                    selectElement.id = `select_product_name_${formIndex}`;
                    selectElement.name = `select_product_name_${formIndex}`;
                    selectElement.innerHTML = '';
            
                    const colorInputElement = lastRow.querySelector('.purchase-input[name^="product_color_"]');
                    colorInputElement.id = `product_color_${formIndex}`;
                    colorInputElement.name = `product_color_${formIndex}`;
                    colorInputElement.value="";

                    const skuInputElement = lastRow.querySelector('.purchase-amount[name^="product_Sku_"]');
                    skuInputElement.id = `product_Sku_${formIndex}`;
                    skuInputElement.name = `product_Sku_${formIndex}`;
                    skuInputElement.value="";

                    const imageInputElement = lastRow.querySelector('img[id^="id_productInward_img_"]');
                    imageInputElement.id = `id_productInward_img_${formIndex}`
                    imageInputElement.value="";


                    const binElement = lastRow.querySelector('select[name^="picklist_products_list-"][name$="-bin_number"]');
                    binElement.id = `id_picklist_products_list-${formIndex}-bin_number`;
                    binElement.name = `picklist_products_list-${formIndex}-bin_number`;
                    binElement.innerHTML = '';

                    const reservedElement = lastRow.querySelector('input[name^="reserver_Qty_"]');
                    reservedElement.id = `id_reserver_Qty_${formIndex}`;
                    reservedElement.name = `reserver_Qty_${formIndex}`;
                    reservedElement.value="";

                    const qunatityInputElement = lastRow.querySelector('input[name^="picklist_products_list-"][name$="-product_quantity"]');
                    qunatityInputElement.id = `id_picklist_products_list-${formIndex}-product_quantity`;
                    qunatityInputElement.name = `picklist_products_list-${formIndex}-product_quantity`;
                    qunatityInputElement.value="";

                    const qunatityhiddenElement = lastRow.querySelector('input[name^="product_quantity"]');
                    qunatityhiddenElement.id = `id_product_quantity-${formIndex}`;
                    qunatityhiddenElement.name = `product_quantity-${formIndex}`;
                    

                
                    const deleteElement = lastRow.querySelector('input[name^="picklist_products_list-"][name$="-DELETE"]');
                    deleteElement.id = `id_picklist_products_list-${formIndex}-DELETE`;
                    deleteElement.name = `picklist_products_list-${formIndex}-DELETE`;
                    deleteElement.value= "";

                    formCountInput.value = formCount + 1; 
                    tableBody.appendChild(lastRow);

                // }
                // document.getElementById('id_productRow').value = '1';
                deleteRowData()
                inputCheck()
              
            }   
             
        });
        
    }else{
        console.error("Could not find addFormButton or table body element.");

    }
    
    });


    function getVisibleRows() {
    // Select all rows that are not hidden (excluding those with display: none)
        const visibleRows = document.querySelectorAll('.mainTableList tr:not([style*="display: none"])');
        return visibleRows;
    }
   function deleteRowData(){
    document.querySelectorAll('.delete-btn').forEach(function (button) {
        button.addEventListener('click', function () {
            const rows =  getVisibleRows();
     
        
            if (rows.length > 1) { // Find the row containing the clicked delete button
                
                const row = this.closest('tr');
                if (row) { // Find the checkbox for deletion in the row
                    
                    const checkRow = row.querySelector('input[name^="picklist_products_list-"][name$="-DELETE"]');
                     const sku = row.querySelector('[name^="product_Sku_"]').value;
                    const binName = row.querySelector('[name$="-bin_number"]').value
                     const productQty = parseInt(row.querySelector('[name$="-product_quantity"]').value) || 0;
                    if (checkRow) {
                        checkRow.checked = true; // Mark as checked
                        checkRow.value = 'true'; // Set the value to 'true'
                        row.style.display = 'none';
              

                        $.ajax({
                            url: '/deleteformquantityrevert/',
                            method: 'GET',
                            data: { 
                               'skus':sku,
                               "binName": binName,
                               "productQty": productQty
                            },
                            success:function(response){
                                console.log(response)
                            },
                            error:function(error){
                                console.log(error)
                            }
                        })


                        inputCheck();
                    } else {
                        console.error("Checkbox for deletion not found in this row");
                    }
                }
            } else {
                // If only one row remains, alert the user
                alert('Cannot delete this row; at least one row must remain.');
            }
        });
    }); 
};

function updateForm(){
    var formId = document.getElementById('id_picklist_products_list-0-id').value;

    if(formId !== ''){
        
        var addButton = document.getElementById('addRowButton');
        var productRow = document.getElementById('id_productRow');
        var submitButton = document.getElementById('picklistSubmit')
    
        addButton.style.display = 'none';
        productRow.style.display = 'none';
        submitButton.style.display = 'none';
    
    }
}

document.addEventListener('DOMContentLoaded', function () {
    document.getElementById('id_picklist_no').focus();
    updateForm()
})

function inputCheck(){

const itemNameInputsid = document.querySelectorAll('[name$="-product_name_value"]');
const date = document.getElementById('pickListDate')
var tableRows = document.querySelectorAll('#createpickListTable tr');
itemNameInputsid.forEach((input, index) => {
  input.addEventListener("keydown", function (event) {

      const closestRow = input.closest('tr');
      const allInputsInRow = closestRow.querySelector('[name$="-product_name_value"]').value;
      const binInput = closestRow.querySelector('[name$="-bin_number"]');
          if(allInputsInRow === ''){
              if (event.key === "Tab") {
                  event.preventDefault(); 
                
                  if (input.value.trim() !== "") {
                        if (binInput) {
                            binInput.focus();
                        }
                    } else {
                        input.focus(); // Refocus on the current input if empty
                    }
                }
                if (event.key === 'Enter') {
                    event.preventDefault();
                    const currentTd = input.closest('tr');
                      
                    if (currentTd) {
                        const nextTd = currentTd.nextElementSibling;

                        // Check if next <td> exists and contains an input
                        if (nextTd) {
                            const nextInput = nextTd.querySelector('[name$="-bin_number"]');
                            if (nextInput) {
                                nextInput.focus(); // Move focus to the next input
                            }
                        }
                    }
                }
          }

      
  });
});


date.addEventListener('keydown', function(event) {
    if (event.key === "Tab") {
        event.preventDefault();

        if (date.value === '') {
            date.focus();
            return; 
        }else{
          var tableRow = document.querySelectorAll('#createpickListTable tr');
        for (let row of tableRow) {
            var itemInput = row.querySelector('[name$="product_name_value"]');
            var qtyInput = row.querySelector('[name$="-bin_number"]');

            if (itemInput && itemInput.value === '') {
                itemInput.focus();
                return; 
            } 
            // Check if quantity is empty, then focus on it
            else if (qtyInput && qtyInput.value === '') {
                qtyInput.focus();
                return; 
            }
        }
        }

        
    }
});

tableRows.forEach(function (row,index) {
    const qty = row.querySelector('[name$="-product_quantity"]');
    const bin_no = row.querySelector('[name$="-bin_number"]')
    if(bin_no){
        bin_no.addEventListener('keydown', function (event) {
            if (event.key === "Tab") {
                event.preventDefault();
                if (bin_no.value === '') {
         
                    bin_no.focus();
                } else if(qty) {
                   
                    qty.focus();
                  
                    
                }
            }
        });
    }
    
    

});


}

inputCheck()
deleteRowData()
</script>
{% endblock body %}