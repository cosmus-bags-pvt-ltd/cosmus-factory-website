{% extends 'product/base.html' %} 
{% load static %} 

{% block body %}
<form class="mt-3" action="" method="POST" id="salesForm">
    {% csrf_token %}
   
    <div class="d-flex mb-3">
      <div class="d-flex mb-1">
        <input type="hidden" id="productSaleDate" value="">
      </div>
      <span id="purchaseError" class="error-messages"></span>
      <div class="d-flex">
        <label for="id_sales_return_no" class="me-2">Sales Return No:</label>

        <input type="text" class="purchase-vNo" name="sales_return_no" id="id_sales_return_no" value="" maxlength="255" required>

      </div>

      <span id="SupplierError" class="error-messages"></span>

      <div class="d-flex ms-3">
        <label for="id_sales_voucher_master" class="me-2">Sales No :</label>
        {% if master_form.instance.id %}
        <input type="text" class="purchase-vNo me-2" name="sales_voucher_master" id="id_sales_voucher_master"
          value="" maxlength="255" required>
          {% elif not master_form.instance.id %}
          <input type="text" class="purchase-vNo me-2" name="sales_voucher_master" id="id_sales_voucher_master"
          value="" maxlength="255" required>
          {% endif %}
      </div>
      <div class="d-flex ms-3">
        <label for="id_ledger_type" class="me-1">ledger Type :</label>
        <input type="text" class="purchase-itemName" name="ledger_type" id="id_ledger_type"
          value="{{master_form.instance.ledger_type}}" maxlength="50" default='Sales'
          placeholder="Sales" readonly>
      </div>
      <div class="ms-2">
        <label for="id_selected_warehouse" class="me-2">Warehouse :</label>
        <input type="hidden" class="purchase-itemName text-black" name="selected_warehouse" required id="id_selected_warehouse" value="{{master_form.instance.selected_warehouse.id}}">
        <input type="text" class="purchase-itemName text-black" name="selected_warehouse_name" required id="id_selected_warehouse_Name" value="{{master_form.instance.selected_warehouse.warehouse_name_finished}}" readonly>
        
      </div>
      <span id="purchaseError" class="error-messages"></span>
      <div class="d-flex">
        <label for="id_party_name" class="me-3">Party A/C Name :</label>
        <input type="hidden" class="item-select text-black" name="party_name"  id="id_party_name" value="{{master_form.instance.party_name.id}}">
        <input type="text" class="item-select text-black" name="party_name_value" required id="id_party_name_value" value="{{master_form.instance.party_name.name}}" readonly>
      </div>
    
    </div>
  
    <div class="row">
        <div class="col-lg-6">
            <div class="mb-2">
                <label for="inwordSerialNo" class="fw-bold me-2">Scan :</label>
                <input type="text" name="scanned_serial_number" class="item-selects ms-3" id="inwordSerialNo">
                <label for="id_bin_Name" class="fw-bold ms-2 me-3">Bin :</label>
                <select  class="item-selects ms-3" name="product_bin" id="id_bin_Name">
                </select>
            </div>
            <div class="d-flex ">
                <div class="mb-2">
                    <label for="id_manualSerialNo" class="fw-bold">M-Scan :</label>
                    <input type="text" name="manual_serial_number" class="item-selects" id="id_manualSerialNo">
                </div>
                <span id="responseMessage" class="ms-5 mb-1 fw-bold"></span>
            </div>
        </div>
        <div class="col-lg-6 " style="display:block" id="stockTransferList">
           
            <table class="table table-striped table-hover table-bordered" id="stockTransferInstanceTable">
                <thead class="name_absolute">
                    <tr>
                        <th>Name</th>
                        <th>SKU</th>
                        <th>Color</th>
                        <th>IMG</th>
                    </tr>
                </thead>
                <tbody class="mainTableList" >
                   
                    <tr>
                        <td><input name="product_name" type="text" class="productShadeCutting_Material_input" id="id_product" value="" readonly></td>
                        <td><input name="product_sku" type="number" class="productorder_input"  id="id_product_sku" value="" readonly></td>
                        <td><input name="product_color" type="text" class="productorder_input"  id="id_product_color" value="" readonly></td>
                        <td>
                            <img id="productImgPreview" name="product_img" src="" alt="Product" style="width: 30px; height: 30px;">
                       </td>
                    
                        
                    </tr>
                 
                </tbody>
            </table>
            
                <button type="submit"  class="newProductCreateBtn" name="save" value="Save" id="stockTarnsferBin">Submit</button>
           
        </div>
        
    </div>
    <div>
        <table class="table table-striped table-hover table-bordered">
            <thead class="name_absolute">
                <tr>
                    <th>Outward No:</th>
                    <th>Total Qty:</th>
                </tr>
                <tr>
                    <th>No</th>
                    <th>Img</th>
                    <th>Ref No</th>
                    <th>Model Name</th>
                    <th>Color</th>
                    <th>Sku</th>
                    <th>Serial No</th>
                    <th>Bin No</th>
                    <th>Qty</th>
                </tr>
            </thead>
            <tbody class="mainTableList" >
                <tr>
                    <td></td>
                </tr>
            </tbody>
            
        </table>
    </div>

<script>
   $(document).ready(function(){

    $('#id_sales_voucher_master').on('blur',function(){
        var saleNo = $(this).val();
        console.log('saleNo',saleNo)
        $.ajax({
            url: '',
           type: 'GET',
           data: { 
               'saleNo':saleNo,
           },
           success: function(response){
            console.log(response);
           },
           error:function(error){
            console.log(error)
           }
        })
    })

 
       let debounceTimeout;
   
       // Handle input in inwordSerialNo
       $('#inwordSerialNo').on('input', function () {
           clearTimeout(debounceTimeout);
   
           // Clear id_manualSerialNo
           const manual_serial = $('#id_manualSerialNo');
           manual_serial.val('');
           
           const responseMessage = $('#responseMessage');
           responseMessage.html(''); // Clear any previous messages

           const inputField = $(this);
   
           debounceTimeout = setTimeout(async function () {
               let inputUrl = inputField.val();
               let serialNo = '';
   
               // Extract serial number
               if (inputUrl.includes('=')) {
                   serialNo = inputUrl.split('=').pop();
                   inputField.val(serialNo);
                   inputField.css('color', 'black');
               }
   
               if (serialNo) {
                   try {
                       const response = await sendSerialNumber(serialNo);
                       $('#responseMessage').html('<span class="text-success">' + response.message + '</span>');
                   } catch (error) {
                       const errorMessage = error.responseJSON?.message || 'An unexpected error occurred.';
                       $('#responseMessage').html('<span class="text-danger">' + errorMessage + '</span>');
                   }
               }
           }, 500); // Debounce delay
       });
   
       // Handle input in id_manualSerialNo
       $('#id_manualSerialNo').on('input', function () {
           // Clear inwordSerialNo
           $('#inwordSerialNo').val('');
   
           const responseMessage = $('#responseMessage');
           responseMessage.html(''); // Clear any previous messages

       });
   
       // Handle click on the normal button
       $('#id_manualSerialNo').on('keydown', async function (event) {
            if(event.key === 'Enter'){
                event.preventDefault();
                const manualSerialNo = $('#id_manualSerialNo').val();
                const responseMessage = $('#responseMessage'); // Response message container
                    if (manualSerialNo) {
                        try {
                            const response = await sendSerialNumber(manualSerialNo);
                            
                            $('#responseMessage').html('<span class="text-success">' + response.message + '</span>');
                           
                        } catch (error) {
                            const errorMessage = error.responseJSON?.message || 'An unexpected error occurred.';
                            $('#responseMessage').html('<span class="text-danger">' + errorMessage + '</span>');
                            $('#id_manualSerialNo').val('');
                            $('#id_product').val('');
                            $('#id_product_sku').val('');
                            $('#id_product_color').val('');
                         
                        }
                    } else {
                        $('#responseMessage').html('<span class="text-danger">Please enter a Manual Serial Number.</span>');
                        $('#id_manualSerialNo').val('');
                        $('#id_product').val('');
                        $('#id_product_sku').val('');
                        $('#id_product_color').val('');
                    }
                    
            }
           

       });
   
       // Function to send serial number to the backend
        async function sendSerialNumber(serialNo) {
            const csrfToken = $('input[name="csrfmiddlewaretoken"]').val();
            const instance_number = $('#id_voucher_no').val();
            const instance_type = $('#id_voucher_type').val();
         
            try {
                const response = await $.ajax({
                    url: '/processserialno/',
                    type: 'POST',
                    data: { 
                        serialNo: serialNo, 
                        csrfmiddlewaretoken: csrfToken,
                        instance_number_post: instance_number,
                        instance_type_post: instance_type
                    },
                });
                
                // Extract product SKU from response
                const productSku = response.product_sku;
                const mainsku = document.querySelectorAll('[name$="-product_sku"]');
                console.log(productSku, typeof(productSku))
               
              
                let isMatch = false;
                mainsku.forEach(function (item) {
                    const sku = parseInt(item.value);
                    console.log(sku, typeof(sku))
                    if (sku === productSku) {
                        isMatch = true;
                    }
                });

                if (!isMatch) {
                    alert('SKU does not match!');
                    throw new Error('SKU mismatch'); // Prevent further execution and returning the response
                }

                $('#id_product').val(response.model_name);
                $('#id_product_sku').val(response.product_sku);
                $('#id_product_color').val(response.product_color);
                $('#productImgPreview').attr('src', response.product_image);

                const binSelect = $('#id_bin_Name');  // Container for displaying the bin list
         
                binSelect.empty(); // Clear existing options

                response.bin_to_dict.forEach(bin => {
                    binSelect.append(new Option(`${bin.bin_name} - ${bin.bin_size} - ${bin.products_in_bin}`, bin.bin_id));
                });
    
                return response;
            } catch (error) {
                console.error('Error:', error);
                return null; // Optionally return null or handle the error further
            }
        }
   })
</script>
{% endblock body %}